/******** 专业测评 ********/
// 问卷 30 题（精简文本表述）
const PRO_Q = [
  "最近一周，您觉得自己的身体总体感觉如何？",
  "您有多久没有好好休息、让身体放松？",
  "您是否经常关注自己身体的舒适感或不适感？",
  "您最近会主动为身体做些友好的事吗？",
  "您觉得自己和身体的关系更像朋友还是评判者？",
  "过去一周，您觉得自己的活力如何？",
  "您会因为身体状态影响到心情吗？",
  "最近一周，您是否经常感到焦虑或烦躁？",
  "您是否容易因为琐事心情低落？",
  "您最近会主动采取措施缓解情绪吗？",
  "您是否因外界评价而感到自卑或压力大？",
  "您有情绪波动时，能觉察并接纳吗？",
  "您最近是否有明显的压力源？",
  "面对压力时，您会主动寻求支持吗？",
  "最近一周，您的睡眠质量如何？",
  "您是否经常对自己的外貌/体型感到不满？",
  "您会反复回想别人对您的评价吗？",
  "您是否会放大身体上的细节缺陷？",
  "不顺利时会把原因归因于身体或外貌吗？",
  "您会用积极、宽容的视角看待自己吗？",
  "您更容易自责还是自我鼓励？",
  "您能接受“身体多样性，无统一标准”吗？",
  "面对消极想法时，能否积极调整？",
  "最近一周，您有规律运动吗？",
  "您会强迫自己节食/锻炼以追求外貌目标吗？",
  "饮食更关注健康还是体型？",
  "最近是否有规律作息并保证睡眠？",
  "您会尝试新的自我关怀行为吗？",
  "遇到困扰更倾向自我调节还是寻求帮助？",
  "您是否认同身体的价值在于陪伴和功能？"
];
// 维度映射（A/B/C/D）与是否反向（r=true 为反向计分）
const MAP = {
  A:[{i:1,r:true},{i:2,r:true},{i:3,r:false},{i:4,r:true},{i:5,r:true},{i:6,r:true},{i:28,r:true}],
  B:[{i:7,r:false},{i:8,r:false},{i:9,r:false},{i:10,r:true},{i:12,r:true},{i:13,r:false},{i:14,r:true},{i:29,r:true}],
  C:[{i:11,r:false},{i:16,r:false},{i:17,r:false},{i:18,r:false},{i:19,r:false},{i:20,r:true},{i:21,r:true},{i:22,r:true},{i:23,r:true},{i:30,r:true}],
  D:[{i:15,r:true},{i:24,r:true},{i:25,r:false},{i:26,r:true},{i:27,r:true}]
};
const labelMap = {A:"A 身体关怀", B:"B 情绪", C:"C 身体形象", D:"D 行为习惯"};

function renderProQs(){
  const box=document.getElementById('proQBox'); if(!box || box.dataset.rendered==='1') return;
  box.innerHTML = PRO_Q.map((q,idx)=>`
    <div class="bg-white rounded-xl p-4 card-shadow">
      <div class="text-sm mb-2">${idx+1}. ${q}</div>
      <div class="grid grid-cols-5 gap-2 text-center text-xs">
        ${[1,2,3,4,5].map(v=>`
          <label class="border rounded-lg py-2">
            <input type="radio" name="pq${idx}" value="${v}" class="hidden">
            <div>${v}</div>
          </label>`).join("")}
      </div>
    </div>`).join("");
  box.dataset.rendered='1';
}
document.getElementById('startProBtn')?.addEventListener('click', renderProQs);
otherLinks.forEach(l=>{ if(l.getAttribute('data-target')==='proAssessPage'){ l.addEventListener('click', renderProQs); }});

const riskScore=(v,rev)=> rev? (6-v) : v; // 1~5 -> 风险 1~5
const standardize=(sum,n)=> Math.round(((sum-1*n)/(4*n))*100); // 0~100
const grade100=(s)=> s<=33?{label:"良好",cls:"bg-green-50 text-green-700"}: s<=66?{label:"需要练习",cls:"bg-yellow-50 text-yellow-700"}:{label:"优先关注",cls:"bg-red-50 text-red-700"};

let radarRef=null;
document.getElementById('proReset')?.addEventListener('click', ()=>{
  document.querySelectorAll('#proQBox input[type="radio"]').forEach(i=>i.checked=false);
  document.getElementById('proResult').classList.add('hidden');
});
document.getElementById('proSubmit')?.addEventListener('click', ()=>{
  const vals=[];
  for(let i=0;i<PRO_Q.length;i++){
    const sel=document.querySelector(`input[name="pq${i}"]:checked`);
    if(!sel){ alert('还有题目未作答'); return; }
    vals.push(Number(sel.value));
  }
  const calc=(arr)=> arr.reduce((a,{i,r})=> a + riskScore(vals[i-1],r),0);
  const A=calc(MAP.A), B=calc(MAP.B), C=calc(MAP.C), D=calc(MAP.D);
  const A100=standardize(A, MAP.A.length), B100=standardize(B, MAP.B.length), C100=standardize(C, MAP.C.length), D100=standardize(D, MAP.D.length);
  const overall=Math.round((A100+B100+C100+D100)/4);

  const GA=grade100(A100), GB=grade100(B100), GC=grade100(C100), GD=grade100(D100), GO=grade100(overall);
  const plan=[];
  if(A100>66) plan.push("连续 7 天“睡眠优先周”：固定就寝 + 3 分钟呼吸；本周 2 次身体扫描 5 分钟");
  else if(A100>33) plan.push("每日 3 分钟冥想 + 晚间 30 分钟电子屏幕关闭；一周 2 次温和拉伸");
  if(B100>66) plan.push("今日 1 次自动思维记录；本周 1 次小型行为实验；必要时考虑求助渠道");
  else if(B100>33) plan.push("每日 4-2-6 呼吸×2 + 情绪命名×1；波动时使用五感觉察");
  if(C100>66) plan.push("设计 1 个行为实验（如与信任的人共餐）；每周 3 次思维记录；减少镜前检查/社媒比较时长");
  else if(C100>33) plan.push("本周 2 次思维记录（聚焦外貌想法）；“身体中立 3 步” + 3 条身体功能感恩");
  if(D100>66) plan.push("停止惩罚式节食；采用盘子法与规律三餐；设置 7 天步行 5000 步挑战");
  else if(D100>33) plan.push("每周 3 次 15 分钟轻运动；规律作息；饮食以“非限制、均衡”为原则");

  // 渲染
  document.getElementById('proResult').classList.remove('hidden');
  document.getElementById('proOverall').innerHTML = `总评：<span class="px-2 py-0.5 rounded-full ${GO.cls}">${GO.label}</span>（综合 ${overall}/100）<div class="mt-1 text-xs text-gray-600">A:${A100}｜B:${B100}｜C:${C100}｜D:${D100}</div>`;
  document.getElementById('proBadges').innerHTML = `
    <div>A：<span class="px-2 py-0.5 rounded-full ${GA.cls}">${GA.label}</span></div>
    <div>B：<span class="px-2 py-0.5 rounded-full ${GB.cls}">${GB.label}</span></div>
    <div>C：<span class="px-2 py-0.5 rounded-full ${GC.cls}">${GC.label}</span></div>
    <div>D：<span class="px-2 py-0.5 rounded-full ${GD.cls}">${GD.label}</span></div>
  `;
  document.getElementById('proPlan').innerHTML = plan.map(p=>`<li>${p}</li>`).join("");

  const ctx=document.getElementById('proChart');
  if(radarRef) radarRef.destroy();
  radarRef=new Chart(ctx,{type:'radar',data:{labels:[labelMap.A,labelMap.B,labelMap.C,labelMap.D],datasets:[{label:'风险（越高越需关注）',data:[A100,B100,C100,D100]}]},options:{responsive:true,scales:{r:{beginAtZero:true,max:100}},plugins:{legend:{display:false}}}});

  // 导出
  document.getElementById('proCSV').onclick = ()=>{
    const header=["时间","类型","A","B","C","D","综合","计划"];
    const row=[new Date().toLocaleString(),"pro",A100,B100,C100,D100,overall,plan.join(" / ")];
    const csv=[header,row].map(r=>r.map(x=>`"${(x+"").replace(/"/g,'""')}"`).join(",")).join("\n");
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"}); const url=URL.createObjectURL(blob);
    const a=document.createElement("a"); a.href=url; a.download="mindfit_pro.csv"; a.click(); URL.revokeObjectURL(url);
  };
  document.getElementById('proPDF').onclick = ()=>{
    const html=document.getElementById('proResult').innerHTML;
    const w=window.open("","_blank"); w.document.write(`<html><head><title>专业测评报告</title></head><body>${html}</body></html>`); w.document.close(); w.print();
  };
});
