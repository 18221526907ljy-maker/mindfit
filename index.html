/*****************
       * å†¥æƒ³/æ­£å¿µ
       *****************/
      const audio = document.getElementById("audio");
      const playBtn = document.getElementById("playPauseBtn");
      const playIcon = document.getElementById("playPauseIcon");
      const seekBar = document.getElementById("seekBar");
      const vol = document.getElementById("volumeBar");
      const cur = document.getElementById("currentTime");
      const total = document.getElementById("totalTime");

      let timerId = null;

      function updateTimeDisplay(sec) {
        const m = String(Math.floor(sec / 60)).padStart(2, "0");
        const s = String(Math.floor(sec % 60)).padStart(2, "0");
        return `${m}:${s}`;
      }

      function setTotal(sec) {
        total.textContent = updateTimeDisplay(sec);
        seekBar.max = String(sec);
      }

      setTotal(180); // é»˜è®¤ 3 åˆ†é’Ÿ

      // Audio controlsï¼ˆå¯é€‰ï¼‰
      playBtn.addEventListener("click", () => {
        if (audio.paused) {
          audio.play().catch(() => {});
          playBtn.innerHTML = '<i class="fa fa-pause"></i>';
          playIcon.className = "fa fa-pause text-white text-3xl";
        } else {
          audio.pause();
          playBtn.innerHTML = '<i class="fa fa-play"></i>';
          playIcon.className = "fa fa-play text-white text-3xl";
        }
      });
      audio.addEventListener("timeupdate", () => {
        seekBar.value = Math.floor(audio.currentTime);
        cur.textContent = updateTimeDisplay(audio.currentTime);
      });
      seekBar.addEventListener("input", () => (audio.currentTime = Number(seekBar.value)));
      vol.addEventListener("input", () => (audio.volume = Number(vol.value)));

      // è®¡æ—¶ç»ƒä¹ 
      document.getElementById("startPracticeBtn").addEventListener("click", () => {
        let sec = 0;
        clearInterval(timerId);
        timerId = setInterval(() => {
          sec += 1;
          cur.textContent = updateTimeDisplay(sec);
          seekBar.value = sec;
          if (sec >= 180) {
            clearInterval(timerId);
            const db = loadDB();
            db.mindfulness.push({ seconds: sec, ts: Date.now() });
            touchStreak(db);
            saveDB(db);
            unlockBadgesIfNeeded(db);
            renderHome();
            showToast("ç»ƒä¹ å®Œæˆï¼Œå·²è®°å½• 3 åˆ†é’Ÿ");
          }
        }, 1000);
      });

      document.getElementById("btnStepBack").addEventListener("click", () => (audio.currentTime = Math.max(0, audio.currentTime - 5)));
      document.getElementById("btnStepForward").addEventListener("click", () => (audio.currentTime = Math.min(Number(seekBar.max), audio.currentTime + 5)));

      document.getElementById("btnCache").addEventListener("click", () => {
        const db = loadDB();
        db.cachedAudio = true;
        saveDB(db);
        showToast("å·²è®°ä¸ºç¦»çº¿å¯ç”¨æç¤ºï¼ˆç¤ºä¾‹ï¼‰");
      });

      /*****************
       * æˆ‘çš„è®°å½•åˆ—è¡¨ & å¯¼å‡º
       *****************/
      document.querySelectorAll(".filter-btn").forEach((b) =>
        b.addEventListener("click", () => {
          document.querySelectorAll(".filter-btn").forEach((x) => x.classList.replace("bg-primary", "bg-gray-100"));
          document.querySelectorAll(".filter-btn").forEach((x) => x.classList.replace("text-white", "text-gray-600"));
          b.classList.replace("bg-gray-100", "bg-primary");
          b.classList.replace("text-gray-600", "text-white");
          renderRecordList(b.dataset.filter);
        })
      );

      function renderRecordList(filter = "all") {
        const db = loadDB();
        const box = document.getElementById("recordList");
        let items = [];

        if (filter === "all" || filter === "thought") {
          items = items.concat(db.records.map((r) => ({ type: "thought", ts: r.ts, data: r })));
        }
        if (filter === "all" || filter === "emotion") {
      function renderRecordList(filter = "all") {
        const db = loadDB();
        const box = document.getElementById("recordList");
        let items = [];

        if (filter === "all" || filter === "thought") {
          items = items.concat(db.records.map((r) => ({ type: "thought", ts: r.ts, data: r })));
        }
        if (filter === "all" || filter === "emotion") {
          items = items.concat(db.emotions.map((e) => ({ type: "emotion", ts: e.ts, data: e })));
        }
        if (filter === "all" || filter === "experiment") {
          items = items.concat(db.experiments.map((e) => ({ type: "experiment", ts: e.ts, data: e })));
        }
        if (filter === "all" || filter === "mindfulness") {
          items = items.concat(db.mindfulness.map((m) => ({ type: "mindfulness", ts: m.ts, data: m })));
        }
        if (filter === "all" || filter === "assessment") {
          items = items.concat(db.assessments.map((a) => ({ type: "assessment", ts: a.ts, data: a })));
        }

        items.sort((a, b) => b.ts - a.ts);

        if (!items.length) {
          box.innerHTML = `<div class="text-sm text-gray-500">æš‚æ— è®°å½•</div>`;
          return;
        }

        box.innerHTML = items
          .map((it) => {
            if (it.type === "thought") {
              const r = it.data;
              return `<div class="bg-white rounded-lg p-4 card-shadow">
                <div class="flex justify-between items-start mb-2">
                  <div class="flex items-center">
                    <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mr-2">
                      <i class="fa fa-pencil text-primary text-sm"></i>
                    </div>
                    <h4 class="font-medium">è‡ªåŠ¨æ€ç»´è®°å½•</h4>
                  </div>
                  <span class="text-xs text-gray-500">${fmtTime(it.ts)}</span>
                </div>
                <p class="text-sm text-gray-600 line-clamp-2 mb-3">æƒ…å¢ƒï¼š${r.context}â€¦ æƒ…ç»ªå¼ºåº¦ï¼š${r.emotion}åˆ†</p>
                <span class="badge bg-blue-50 text-primary">æ€ç»´</span>
              </div>`;
            }
            if (it.type === "emotion") {
              return `<div class="bg-white rounded-lg p-4 card-shadow">
                <div class="flex justify-between items-start mb-2">
                  <div class="flex items-center">
                    <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center mr-2">
                      <i class="fa fa-heart-o text-secondary text-sm"></i>
                    </div>
                    <h4 class="font-medium">æƒ…ç»ªç»ƒä¹ å®Œæˆ</h4>
                  </div>
                  <span class="text-xs text-gray-500">${fmtTime(it.ts)}</span>
                </div>
                <p class="text-sm text-gray-600 mb-2">ç»ƒä¹ ï¼š${it.data.card}</p>
                <span class="badge bg-green-50 text-secondary">ç»ƒä¹ </span>
              </div>`;
            }
            if (it.type === "experiment") {
              const e = it.data;
              return `<div class="bg-white rounded-lg p-4 card-shadow">
                <div class="flex justify-between items-start mb-2">
                  <div class="flex items-center">
                    <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center mr-2">
                      <i class="fa fa-flask text-accent text-sm"></i>
                    </div>
                    <h4 class="font-medium">è¡Œä¸ºå®éªŒ</h4>
                  </div>
                  <span class="text-xs text-gray-500">${fmtTime(it.ts)}</span>
                </div>
                <p class="text-sm text-gray-600 line-clamp-2 mb-2">${e.belief}</p>
                <span class="badge bg-purple-50 text-purple-600">å®éªŒ</span>
              </div>`;
            }
            if (it.type === "mindfulness") {
              return `<div class="bg-white rounded-lg p-4 card-shadow">
                <div class="flex justify-between items-start mb-2">
                  <div class="flex items-center">
                    <div class="w-8 h-8 rounded-full bg-yellow-100 flex items-center justify-center mr-2">
                      <i class="fa fa-headphones text-yellow-500 text-sm"></i>
                    </div>
                    <h4 class="font-medium">å†¥æƒ³ç»ƒä¹ </h4>
                  </div>
                  <span class="text-xs text-gray-500">${fmtTime(it.ts)}</span>
                </div>
                <p class="text-sm text-gray-600 mb-2">æ—¶é•¿ï¼š${Math.round(it.data.seconds / 60)} åˆ†é’Ÿ</p>
                <span class="badge bg-yellow-50 text-yellow-600">å†¥æƒ³</span>
              </div>`;
            }
            if (it.type === "assessment") {
              return `<div class="bg-white rounded-lg p-4 card-shadow">
                <div class="flex justify-between items-start mb-2">
                  <div class="flex items-center">
                    <div class="w-8 h-8 rounded-full bg-pink-100 flex items-center justify-center mr-2">
                      <i class="fa fa-question-circle text-pink-500 text-sm"></i>
                    </div>
                    <h4 class="font-medium">èº«å¿ƒè½»æµ‹è¯„</h4>
                  </div>
                  <span class="text-xs text-gray-500">${fmtTime(it.ts)}</span>
                </div>
                <p class="text-sm text-gray-600 mb-2">æ€»åˆ†ï¼š${it.data.score}ï¼ˆ9~45ï¼‰</p>
                <span class="badge bg-pink-50 text-pink-600">æµ‹è¯„</span>
              </div>`;
            }
          })
          .join("");
      }

      // å¯¼å‡ºæ‰€æœ‰ CSV
      document.getElementById("btnExportAll").addEventListener("click", () => {
        const db = loadDB();
        const combine = [];
        db.records.forEach((r) => combine.push(["æ€ç»´è®°å½•", fmtTime(r.ts), r.context, r.thought.replace(/\n/g, " "), (r.evidence || "").replace(/\n/g, " "), r.emotion]));
        db.emotions.forEach((e) => combine.push(["æƒ…ç»ªç»ƒä¹ ", fmtTime(e.ts), e.card, "", "", ""]));
        db.experiments.forEach((e) => combine.push(["è¡Œä¸ºå®éªŒ", fmtTime(e.ts), e.belief.replace(/\n/g, " "), (e.predict || "").replace(/\n/g, " "), (e.actual || "").replace(/\n/g, " "), ""]));
        db.mindfulness.forEach((m) => combine.push(["å†¥æƒ³", fmtTime(m.ts), `æ—¶é•¿${Math.round(m.seconds / 60)}åˆ†é’Ÿ`, "", "", ""]));
        db.assessments.forEach((a) => combine.push(["æµ‹è¯„", fmtTime(a.ts), `æ€»åˆ†${a.score}`, "", "", ""]));
        if (!combine.length) return showToast("æš‚æ— æ•°æ®å¯å¯¼å‡º");

        const header = ["ç±»å‹", "æ—¶é—´", "A", "B", "C", "D"];
        const csv = [header, ...combine].map((r) => r.map((x) => `"${(x + "").replace(/"/g, '""')}"`).join(",")).join("\n");
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = "mindfit_all_records.csv"; a.click();
        URL.revokeObjectURL(url);
      });

      // æ¸…ç©ºæ•°æ®
      document.getElementById("btnClearAll").addEventListener("click", () => {
        if (!confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æœ¬åœ°æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚")) return;
        localStorage.removeItem(DB_KEY);
        showToast("å·²æ¸…ç©ºæœ¬åœ°æ•°æ®");
        renderHome();
        renderRecordList("all");
        renderBadges();
      });

      /*****************
       * å¾½ç« ç³»ç»Ÿ
       *****************/
      const BADGE_RULES = [
        { id: "tr_3", name: "æ€ç»´è®°å½•è€…", icon: "fa-pencil", color: "text-primary", desc: "å®Œæˆ 3 æ¬¡è‡ªåŠ¨æ€ç»´è®°å½•", check: (db) => db.records.length >= 3 },
        { id: "emo_5", name: "æƒ…ç»ªè°ƒèŠ‚æ–°æ‰‹", icon: "fa-heart-o", color: "text-secondary", desc: "å®Œæˆ 5 æ¬¡æƒ…ç»ªç»ƒä¹ ", check: (db) => db.emotions.length >= 5 },
        { id: "streak_7", name: "åšæŒè€…", icon: "fa-calendar-check-o", color: "text-accent", desc: "è¿ç»­ 7 å¤©ä½¿ç”¨", check: (db) => db.streak.count >= 7 },
      ];

      function unlockBadgesIfNeeded(db) {
        let unlockedName = null;
        BADGE_RULES.forEach((b) => {
          if (b.check(db) && !db.badges[b.id]) {
            db.badges[b.id] = true;
            unlockedName = b.name;
          }
        });
        saveDB(db);
        if (unlockedName) {
          const banner = document.getElementById("badgeBanner");
          const text = document.getElementById("badgeBannerText");
          text.textContent = unlockedName;
          banner.classList.remove("hidden");
          setTimeout(() => banner.classList.add("hidden"), 3200);
        }
      }

      function renderBadges() {
        const db = loadDB();
        const unlocked = document.getElementById("badgeUnlocked");
        const locked = document.getElementById("badgeLocked");
        const renderCard = (b, dim = false) => `
          <div class="badge-card bg-white rounded-xl p-4 card-shadow flex flex-col items-center ${dim ? 'opacity-50' : ''}">
            <div class="w-16 h-16 rounded-full ${dim ? 'bg-gray-100' : 'bg-blue-100'} flex items-center justify-center mb-2">
              <i class="fa ${b.icon} ${b.color} text-2xl"></i>
            </div>
            <h4 class="text-sm font-medium text-center mb-1">${b.name}</h4>
            <p class="text-xs text-gray-500 text-center mb-2">${b.desc}</p>
          </div>`;
        unlocked.innerHTML = BADGE_RULES.filter((b) => db.badges[b.id]).map((b) => renderCard(b)).join("") || `<div class="text-sm text-gray-500">æš‚æ— </div>`;
        locked.innerHTML = BADGE_RULES.filter((b) => !db.badges[b.id]).map((b) => renderCard(b, true)).join("") || `<div class="text-sm text-gray-500">å…¨éƒ¨è§£é”å•¦ ğŸ‰</div>`;
      }

      /*****************
       * é¦–é¡µæ¸²æŸ“ï¼ˆè¿›åº¦/æœ€è¿‘/æ¨èï¼‰
       *****************/
      function renderHome() {
        const db = loadDB();
        // è¿›åº¦ï¼šç²—ç•¥ç”¨å„æ¨¡å—å®Œæˆé‡åˆæˆ
        const total = db.records.length + db.emotions.length + db.mindfulness.length + db.experiments.length + db.assessments.length;
        const percent = Math.max(5, Math.min(100, Math.round((total / 20) * 100))); // 20 æ¬¡å®Œæˆâ‰ˆæ»¡è¿›åº¦
        document.getElementById("progressBar").style.width = `${percent}%`;

        // æœ€è¿‘è®°å½•ï¼šå–æœ€è¿‘ 2 æ¡ï¼ˆæ€ç»´/ç»ƒä¹ /å†¥æƒ³/å®éªŒ/æµ‹è¯„æ··æ’ï¼‰
        const recentBox = document.getElementById("recentList");
        const all = []
          .concat(db.records.map((r) => ({ type: "thought", ts: r.ts, tag: "æ€ç»´", icon: "fa-pencil", color: "text-primary" })))
          .concat(db.emotions.map((e) => ({ type: "emotion", ts: e.ts, tag: "ç»ƒä¹ ", icon: "fa-heart-o", color: "text-secondary" })))
          .concat(db.mindfulness.map((m) => ({ type: "mindfulness", ts: m.ts, tag: "å†¥æƒ³", icon: "fa-headphones", color: "text-yellow-500" })))
          .concat(db.experiments.map((m) => ({ type: "experiment", ts: m.ts, tag: "å®éªŒ", icon: "fa-flask", color: "text-accent" })))
          .concat(db.assessments.map((a) => ({ type: "assessment", ts: a.ts, tag: "æµ‹è¯„", icon: "fa-question-circle", color: "text-pink-500" })));
        all.sort((a, b) => b.ts - a.ts);
        const slice = all.slice(0, 2);
        if (!slice.length) {
          recentBox.innerHTML = `<div class="text-sm text-gray-500">æš‚æ— è®°å½•ï¼Œå…ˆå»è¯•è¯•ä¸Šæ–¹çš„å·¥å…·å¡ç‰‡å§ï½</div>`;
        } else {
          recentBox.innerHTML = slice
            .map(
              (x) => `<div class="bg-white rounded-lg p-4 card-shadow flex items-center justify-between">
                <div class="flex items-center">
                  <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center mr-3">
                    <i class="fa ${x.icon} ${x.color}"></i>
                  </div>
                  <div>
                    <p class="font-medium">${x.tag}è®°å½•</p>
                    <p class="text-sm text-gray-500">${fmtTime(x.ts)}</p>
                  </div>
                </div>
                <span class="text-xs bg-gray-50 text-gray-600 px-2 py-1 rounded-full">${x.tag}</span>
              </div>`
            )
            .join("");
        }

        // æ¨èå†…å®¹ï¼šæ ¹æ®æœ€è¿‘ä¸€æ¬¡æƒ…ç»ªå¼ºåº¦
        const recBox = document.getElementById("recommendList");
        const last = db.records.slice(-1)[0];
        const items =
          last && last.emotion >= 7
            ? [
                { img: 31, title: "ç„¦è™‘æ—¶çš„ 90 ç§’æ–¹æ³•", desc: "è¯†åˆ«æƒ…ç»ªâ†’æ·±å‘¼å¸â†’æ”¾æ¾æ‰«æ" },
                { img: 32, title: "ä¸¤åˆ†é’Ÿè‡ªæˆ‘è‚¯å®šè¯­", desc: "å†™ä¸‹ 3 æ¡èº«ä½“åŠŸèƒ½æ„Ÿæ©" },
              ]
            : [
                { img: 33, title: "èº«ä½“ä¸­ç«‹å…¥é—¨", desc: "ä»åŠŸèƒ½ä¸å¥åº·è§’åº¦çœ‹å¾…èº«ä½“" },
                { img: 34, title: "æ­£å¿µé¥®é£Ÿ 5 æ­¥", desc: "æ…¢ä¸€ç‚¹ï¼Œå’Œå‘³é“å¥½å¥½ç›¸å¤„" },
              ];
        recBox.innerHTML = items
          .map(
            (r) => `<div class="bg-white rounded-xl overflow-hidden card-shadow">
              <img src="https://picsum.photos/400/200?random=${r.img}" alt="${r.title}" class="w-full h-40 object-cover">
              <div class="p-4">
                <h4 class="font-semibold mb-1">${r.title}</h4>
                <p class="text-sm text-gray-500 mb-3 line-clamp-2">${r.desc}</p>
                <div class="flex items-center justify-between">
                  <span class="text-xs text-gray-400">2 åˆ†é’Ÿé˜…è¯»</span>
                  <button onclick="location.href='body-neutrality.html'">æŸ¥çœ‹</button>
                </div>
              </div>
            </div>`
          )
          .join("");
      }

      // é¦–æ¬¡è¿›å…¥ï¼Œæ¸²æŸ“é¦–é¡µ
      renderHome();
      renderTRPreview();
    });

    const items = [
      {
        title: "èº«ä½“ä¸­ç«‹å…¥é—¨",
        desc: "ä»åŠŸèƒ½ä¸å¥åº·è§’åº¦çœ‹å¾…èº«ä½“",
        img: 1,
        link: "body-neutrality.html"
      },
      {
        title: "æ­£å¿µé¥®é£Ÿ 5 æ­¥",
        desc: "æ…¢ä¸€ç‚¹ï¼Œå’Œå‘³é“å¥½å¥½ç›¸å¤„",
        img: 2,
        link: "mindful-eating.html"
      },
      {
        title: "ç„¦è™‘èˆ’ç¼“å°ç»ƒä¹ ",
        desc: "3 åˆ†é’Ÿè°ƒèŠ‚èº«ä½“ç´§ç»·ï¼Œå›å½’æ­¤åˆ»",
        img: 3,
        link: "quick-anxiety-relief.html"
      }
    ];

    const recBox = document.getElementById("recommendList");

    recBox.innerHTML = items
      .map((r) => `
        <div class="bg-white rounded-xl overflow-hidden card-shadow">
          <img src="https://picsum.photos/400/200?random=${r.img}" alt="${r.title}" class="w-full h-40 object-cover">
          <div class="p-4">
            <h4 class="font-semibold mb-1">${r.title}</h4>
            <p class="text-sm text-gray-500 mb-3 line-clamp-2">${r.desc}</p>
            <div class="flex items-center justify-between">
              <span class="text-xs text-gray-400">2 åˆ†é’Ÿé˜…è¯»</span>
            </div>
          </div>
        </div>
      `)
      .join("");

  </script>
</body>
</html>  <script>
    /*****************
     * åŸºç¡€å·¥å…· & å­˜å‚¨
     *****************/
    const DB_KEY = "mindfit_db_v1";

    const defaultDB = () => ({
      records: [],          // æ€ç»´è®°å½•
      emotions: [],         // æƒ…ç»ªç»ƒä¹ å®Œæˆ {card, ts}
      experiments: [],      // è¡Œä¸ºå®éªŒ
      mindfulness: [],      // å†¥æƒ³ç»ƒä¹  {seconds, ts}
      assessments: [],      // æµ‹è¯„ç»“æœ
      bmiAssessments: [],   // BMIæµ‹è¯„ç»“æœ
      bodyAnxietyAssessments: [], // èº«æç„¦è™‘æµ‹è¯„ç»“æœ
      badges: {},           // å¾½ç« å¸ƒå°”
      streak: { count: 0, lastDate: "" }, // è¿ç»­å¤©æ•°
      cachedAudio: false,   // å†¥æƒ³éŸ³é¢‘ç¼“å­˜æ ‡è®°ï¼ˆæç¤ºç”¨ï¼‰
    });

    const loadDB = () => {
      try {
        const raw = localStorage.getItem(DB_KEY);
        return raw ? JSON.parse(raw) : defaultDB();
      } catch (e) {
        return defaultDB();
      }
    };

    const saveDB = (db) => localStorage.setItem(DB_KEY, JSON.stringify(db));

    const todayStr = () => {
      const d = new Date();
      return d.toISOString().slice(0, 10);
    };

    const fmtTime = (ts) => {
      const d = new Date(ts);
      const pad = (n) => (n < 10 ? "0" + n : n);
      return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    };

    const showToast = (msg) => {
      const wrap = document.getElementById("toast");
      const box = wrap.firstElementChild;
      box.textContent = msg;
      wrap.classList.remove("hidden");
      setTimeout(() => wrap.classList.add("hidden"), 1800);
    };

    // streak æ›´æ–°ï¼šæ¯å¤©ä»»æ„æ“ä½œä¸€æ¬¡è®°ä¸ºæ´»è·ƒ
    const touchStreak = (db) => {
      const t = todayStr();
      if (db.streak.lastDate === t) return;
      // åˆ¤æ–­æ˜¯å¦è¿ç»­
      const last = db.streak.lastDate ? new Date(db.streak.lastDate) : null;
      const y = new Date(t);
      const one = 24 * 60 * 60 * 1000;
      const isConsecutive = last && (y - last) / one === 1;
      db.streak.count = isConsecutive ? (db.streak.count + 1) : 1;
      db.streak.lastDate = t;
    };

    /*****************
     * é¡µé¢å¯¼èˆª
     *****************/
    document.addEventListener("DOMContentLoaded", () => {
      const pages = document.querySelectorAll(".page");
      const backBtn = document.getElementById("backBtn");
      const pageTitle = document.getElementById("pageTitle");
      const featureCards = document.querySelectorAll(".feature-card");
      const otherLinks = document.querySelectorAll("[data-target]");
      const navBtns = document.querySelectorAll(".nav-btn");

      let pageHistory = ["homePage"];

      const titleMap = {
        homePage: "MindFit èº«å¿ƒç®¡ç†",
        selfAssessmentPage: "äº†è§£è‡ªå·±",
        bmiAssessmentPage: "BMI èº«ä½“æµ‹è¯„",
        bodyAnxietyAssessmentPage: "èº«æç„¦è™‘è‡ªè¯„",
        assessmentPage: "èº«å¿ƒè½»æµ‹è¯„",
        thoughtRecordPage: "è‡ªåŠ¨æ€ç»´è®°å½•",
        emotionRegulationPage: "æƒ…ç»ªè°ƒèŠ‚å¡ç‰‡",
        behaviorExperimentPage: "è¡Œä¸ºå®éªŒæŒ‡å—",
        mindfulnessPage: "å†¥æƒ³/æ­£å¿µç»ƒä¹ ",
        myRecordsPage: "æˆ‘çš„è®°å½•",
        myBadgesPage: "æˆ‘çš„å¾½ç« ",
      };

      // å…¨å±€å¯¼èˆªå‡½æ•°
      window.navigateToSelfAssessment = function() {
        navigateTo('selfAssessmentPage');
      };

      // èº«æç„¦è™‘æµ‹è¯„é¢˜ç›®ï¼ˆå¤ç”¨ç°æœ‰çš„9é¢˜ï¼‰
      const BODY_ANXIETY_QUESTIONS = [
        "ç…§é•œå­æˆ–ç¿»çœ‹ç…§ç‰‡æ—¶ï¼Œæˆ‘ä¼šç‰¹åˆ«å…³æ³¨è‡ªå·±çš„æŸäº›èº«ä½“éƒ¨ä½",
        "æˆ‘ä¼šæŠŠè‡ªå·±å’Œç¤¾äº¤åª’ä½“ä¸Šçš„"å®Œç¾èº«æ"æ¯”è¾ƒ",
        "åƒå®Œå–œæ¬¢çš„é£Ÿç‰©åï¼Œæˆ‘ä¼šæ„Ÿåˆ°åæ‚”æˆ–æ„§ç–š",
        "å¦‚æœå¯¹è‡ªå·±çš„å¤–è²Œä¸æ»¡æ„ï¼Œæˆ‘ä¼šæƒ…ç»ªä½è½æˆ–å¿ƒæƒ…å—åˆ°å½±å“",
        "æˆ‘ä¼šç»™è‡ªå·±åˆ¶å®šä¸¥æ ¼çš„é¥®é£Ÿæˆ–è¿åŠ¨è®¡åˆ’ï¼Œè‹¥æœªå®Œæˆä¼šè‡ªè´£",
        "å› ä¸ºæ‹…å¿ƒèº«æï¼Œæˆ‘ä¼šé¿å…æ‹ç…§æˆ–å‚åŠ ç¤¾äº¤æ´»åŠ¨",
        "æˆ‘è§‰å¾—ç±»ä¼¼äº"å¦‚æœæˆ‘å˜å¾—æ›´å¥½çœ‹ï¼Œç”Ÿæ´»ä¼šæ›´é¡ºåˆ©"è¿™ç±»æƒ³æ³•æœ‰ä¸€å®šé“ç†",
        "æˆ‘æƒ³æ‘†è„±è¿™äº›ç„¦è™‘æƒ³æ³•ï¼Œä½†ä¸çŸ¥é“ä»å“ªé‡Œå¼€å§‹",
        "å¦‚æœæœ‰ç®€å•å¯æ“ä½œçš„å¿ƒç†è‡ªåŠ©ç»ƒä¹ ï¼ˆä¾‹å¦‚æ€ç»´è®°å½•ã€æƒ…ç»ªå¡ç‰‡ç­‰ï¼‰ï¼Œæˆ‘æ„¿æ„å°è¯•",
      ];

      let currentQuestion = 0;
      let bodyAnxietyAnswers = [];

      function navigateTo(id) {
        pages.forEach((p) => p.classList.add("hidden"));
        const target = document.getElementById(id);
        if (!target) return;
        target.classList.remove("hidden");
        pageTitle.textContent = titleMap[id] || "MindFit";
        if (pageHistory[pageHistory.length - 1] !== id) pageHistory.push(id);
        window.scrollTo(0, 0);
        
        // è¿›å…¥é¡µé¢æ—¶æ¸²æŸ“
        switch (id) {
          case "homePage":
            renderHome();
            break;
          case "selfAssessmentPage":
            renderRecentAssessments();
            break;
          case "bodyAnxietyAssessmentPage":
            initBodyAnxietyAssessment();
            break;
          case "thoughtRecordPage":
            renderTRPreview();
            break;
          case "emotionRegulationPage":
            renderEmotionStats();
            renderEmotionRecs();
            break;
          case "behaviorExperimentPage":
            renderBXList();
            break;
          case "myRecordsPage":
            renderRecordList("all");
            break;
          case "myBadgesPage":
            renderBadges();
            break;
          case "assessmentPage":
            renderAssessment();
            break;
        }
      }

      featureCards.forEach((c) => c.addEventListener("click", () => {
        if (c.onclick) {
          c.onclick();
        } else {
          navigateTo(c.dataset.target);
        }
      }));
      otherLinks.forEach((c) => c.addEventListener("click", () => {
        if (c.dataset.target) {
          navigateTo(c.dataset.target);
        }
      }));
      navBtns.forEach((c) => c.addEventListener("click", () => navigateTo(c.dataset.target)));

      backBtn.addEventListener("click", () => {
        if (pageHistory.length > 1) {
          pageHistory.pop();
          navigateTo(pageHistory[pageHistory.length - 1]);
      document.getElementById("btnAssess").addEventListener("click", () => {
        const db = loadDB();
        const vals = [...document.querySelectorAll(".assess-item")].map((x) => Number(x.value));
        if (vals.length !== QUESTIONS.length) {
          showToast("è¯·å®Œæˆæ‰€æœ‰é¢˜ç›®");
          return;
        }
        const height = parseFloat(document.getElementById("heightInput").value) || null;
        const weight = parseFloat(document.getElementById("weightInput").value) || null;
        const bodyFeel = document.getElementById("bodyFeel").value || "";

        const score = vals.reduce((a, b) => a + b, 0); // 9~45
        const ts = Date.now();

        // ç”Ÿæˆå»ºè®®
        const advice = [];
  
        // 1. æ ¹æ®æ€»åˆ†æ•°ï¼Œæä¾›æ•´ä½“è°ƒèŠ‚å»ºè®®
        if (score >= 30) {
          advice.push("ğŸŒ¿ å»ºè®®ç»´æŒï¼šä½ å·²ç»è¡¨ç°å‡ºè‰¯å¥½çš„è°ƒèŠ‚èƒ½åŠ›ã€‚å»ºè®®æ¯æ—¥ 1 æ¬¡æ­£å¿µå‘¼å¸ï¼ˆçº¦ 2 åˆ†é’Ÿï¼‰ï¼Œå¹¶åŠ å…¥ä¸€æ¬¡è‡ªæˆ‘è‚¯å®šè¯­ç»ƒä¹ ï¼Œä¾‹å¦‚ï¼š"æˆ‘æ„¿æ„æ¸©æŸ”åœ°å¯¹å¾…è‡ªå·±"ã€‚");
        } else {
          advice.push("ğŸŒ¿ å»ºè®®æå‡ï¼šä½ çš„ç„¦è™‘å¯èƒ½è¾ƒæ˜æ˜¾ã€‚è¯·å°è¯•æ¯æ—¥å®‰æ’ 2 æ¬¡æ”¾æ¾ç»ƒä¹ ï¼ˆå¦‚è…¹å¼å‘¼å¸ã€èº«ä½“æ‰«æï¼‰ï¼Œæ¯å‘¨è‡³å°‘ 1 æ¬¡è¿›è¡Œæ€ç»´è®°å½•ï¼Œè§‚å¯Ÿæƒ…ç»ªæ³¢åŠ¨ä¸èº«ä½“çš„å…³ç³»ã€‚");
        }
        
        if (score >= 45) {
          advice.push("ğŸŒŸ éå¸¸è‰¯å¥½ï¼šä½ å±•ç°å‡ºæå¼ºçš„èº«ä½“è§‰å¯Ÿå’Œè°ƒèŠ‚èƒ½åŠ›ã€‚ç»§ç»­ä¿æŒå½“å‰çš„èŠ‚å¥ï¼Œä¹Ÿå¯ä»¥å°è¯•å¸®åŠ©ä»–äººå»ºç«‹èº«å¿ƒè°ƒèŠ‚æ„è¯†ã€‚");
        } else if (score >= 36) {
          advice.push("ğŸŒ¿ çŠ¶æ€ç¨³å®šï¼šä½ å…·å¤‡ä¸€å®šçš„èº«ä½“è§‰å¯ŸåŠ›å’Œè‡ªæˆ‘å…³æ€€èƒ½åŠ›ã€‚å»ºè®®æŒç»­æ¯æ—¥ 1 æ¬¡æ­£å¿µå‘¼å¸ï¼Œå¹¶å®šæœŸå¤ç›˜æƒ…ç»ªä¸èº«ä½“å…³ç³»ã€‚");
        } else if (score >= 25) {
          advice.push("ğŸŒ¤ å¯æå‡ç©ºé—´ï¼šä½ å·²ç»åœ¨å°è¯•è§‰å¯Ÿèº«ä½“ä¸æƒ…ç»ªçš„å…³è”ï¼Œå»ºè®®å°è¯•å°†æ—¥å¸¸ç»ƒä¹ æ›´è§„å¾‹åœ°èå…¥ç”Ÿæ´»ã€‚");
        } else if (score >= 15) {
          advice.push("ğŸŒ§ åˆç°ç„¦è™‘ï¼šä½ å¯èƒ½å·²ç»æ„Ÿå—åˆ°èº«ä½“ä¸Šçš„ç´§ç»·æˆ–ç–²æƒ«ï¼Œä¸ç„¦è™‘ç›¸å…³ã€‚å»ºè®®ä»ç®€å•çš„æ¯æ—¥ä»»åŠ¡å¼€å§‹ï¼Œæ…¢æ…¢å»ºç«‹è°ƒèŠ‚çš„èŠ‚å¥ã€‚");
        } else {
          advice.push("â›ˆ è­¦ç¤ºçŠ¶æ€ï¼šä½ å½“å‰çš„èº«å¿ƒçŠ¶æ€å¯èƒ½å¤„äºè¾ƒé«˜å‹é˜¶æ®µï¼Œå»ºè®®ä¼˜å…ˆè€ƒè™‘è‡ªæˆ‘è°ƒèŠ‚ç»ƒä¹ ï¼Œå¹¶åœ¨éœ€è¦æ—¶å¯»æ±‚ä¸“ä¸šæ”¯æŒã€‚");
        }

        // 2. æ ¹æ®èº«ä½“æ„Ÿå—ï¼ˆbodyFeelï¼‰ç»™å‡ºä¸ªæ€§åŒ–ä»»åŠ¡
        if (bodyFeel === "ä¸è‡ªä¿¡") {
          advice.push("ğŸ“ ä»Šæ—¥å°ä»»åŠ¡ï¼šå†™ä¸‹ 3 æ¡ä½ èº«ä½“çš„åŠŸèƒ½æ€§ä¼˜ç‚¹ï¼ˆä¾‹å¦‚ï¼š"æˆ‘çš„èº«ä½“è®©æˆ‘å¯ä»¥è‡ªç”±è¡Œèµ°"ã€"å¯ä»¥æ¶ˆåŒ–é£Ÿç‰©"ã€"å¯ä»¥æ„ŸçŸ¥æ¸©åº¦"ï¼‰ï¼Œå¹¶å¯¹èº«ä½“è¯´ä¸€å¥é¼“åŠ±çš„è¯ã€‚");
        }
        if (bodyFeel === "ç´§ç»·") {
          advice.push("ğŸ§˜ ä»Šæ—¥å°ä»»åŠ¡ï¼šè¿›è¡Œä¸€æ¬¡ 4-2-6 å‘¼å¸ç»ƒä¹ ï¼ˆå¸æ°” 4 ç§’ï¼Œå±æ¯ 2 ç§’ï¼Œå‘¼æ°” 6 ç§’ï¼Œé‡å¤ 10 è½®ï¼‰ï¼Œæ¥ç€åšè‚©é¢ˆä¼¸å±•æˆ–å…¨èº«æ‘‡æ‘† 5 åˆ†é’Ÿã€‚");
        }
        if (bodyFeel === "ç–²æƒ«") {
          advice.push("ğŸŒ™ ä»Šæ—¥å°ä»»åŠ¡ï¼šä»Šæ™šæ—©ç‚¹å…¥ç¡å‰ï¼Œå°è¯•ç”¨ 3 åˆ†é’Ÿè¿›è¡Œ"èº«ä½“æ‰«æå†¥æƒ³"ï¼ˆä»è„šåˆ°å¤´æ³¨æ„å„éƒ¨ä½æ„Ÿå—ï¼‰ï¼Œå¹¶å¯¹è‡ªå·±è¯´ï¼š"ä»Šå¤©å·²ç»å°½åŠ›äº†"ã€‚");
        }

        // 3. å¯é€‰ï¼šæ¨èé˜…è¯»ææ–™ï¼ˆå›ºå®šæˆ–éšæœºï¼‰
        advice.push("ğŸ“˜ æ¨èé˜…è¯»: <a href='https://www.medicalnewstoday.com/articles/322510' target='_blank'>ã€Šä¸ºä»€ä¹ˆæˆ‘ä»¬ä¼šå¯¹èº«ä½“æ„Ÿåˆ°ç„¦è™‘ã€‹</a> â€” è¿™æ˜¯ä¸€ç¯‡ç®€çŸ­çš„å¿ƒç†å­¦æ–‡ç« ï¼Œå¸®åŠ©ä½ ç†è§£èº«ä½“ç„¦è™‘çš„æ¥æºã€‚");

        db.assessments.push({
          ts,
          score,
          vals,
          height,
          weight,
          bodyFeel,
          advice,
        });
        touchStreak(db);
        saveDB(db);
        unlockBadgesIfNeeded(db);
        renderHome();
        
        const adviceStr = encodeURIComponent(advice.join(",,"));
        window.location.href = `result.html?advice=${adviceStr}`;

        const box = document.getElementById("assessResult");
        const ul = document.getElementById("adviceList");
        ul.innerHTML = advice.map((t) => `<li>${t}</li>`).join("");
        box.classList.remove("hidden");
      /*****************
       * è‡ªåŠ¨æ€ç»´è®°å½•
       *****************/
      const btnSaveTR = document.getElementById("btnSaveTR");
      btnSaveTR.addEventListener("click", () => {
        const contextSel = document.getElementById("trContext").value;
        const contextCustom = document.getElementById("trContextCustom").value.trim();
        const thought = document.getElementById("trThought").value.trim();
        const evidence = document.getElementById("trEvidence").value.trim();
        const emotion = Number(document.getElementById("trEmotion").value) || 5;
        const ctx = contextSel.includes("å…¶ä»–") ? (contextCustom || "æœªå¡«å†™") : (contextSel || contextCustom);

        if (!thought) return showToast("è¯·å…ˆå¡«å†™å½“æ—¶çš„æƒ³æ³•ï½");

        const db = loadDB();
        db.records.push({
          ts: Date.now(),
          context: ctx || "æœªå¡«å†™",
          thought,
          evidence,
          emotion,
        });
        touchStreak(db);
        saveDB(db);
        unlockBadgesIfNeeded(db);
        renderTRPreview();
        renderHome();
        showToast("å·²ä¿å­˜åˆ°æœ¬åœ°è®°å½•");
      });

      function renderTRPreview() {
        const db = loadDB();
        const box = document.getElementById("trPreview");
        if (!db.records.length) {
          box.textContent = "æš‚æ— è®°å½•ï¼Œä¿å­˜åä¼šæ˜¾ç¤ºé¢„è§ˆã€‚";
          return;
        }
        const r = db.records[db.records.length - 1];
        box.innerHTML = `
          <div class="flex justify-between items-start mb-3">
            <span class="text-sm text-gray-500">è®°å½•æ—¶é—´</span>
            <span class="text-sm font-medium">${fmtTime(r.ts)}</span>
          </div>
          <div class="mb-2"><span class="text-sm text-gray-500 block mb-1">æƒ…å¢ƒ</span><p class="text-sm">${r.context}</p></div>
          <div class="mb-2"><span class="text-sm text-gray-500 block mb-1">å½“æ—¶çš„æƒ³æ³•</span><p class="text-sm">${r.thought || "-"}</p></div>
          <div class="mb-2"><span class="text-sm text-gray-500 block mb-1">è¯æ®</span><p class="text-sm">${r.evidence || "-"}</p></div>
          <div><span class="text-sm text-gray-500 block mb-1">æƒ…ç»ªå¼ºåº¦</span>
            <div class="flex items-center">
              <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden mr-2">
                <div class="h-full bg-red-400 rounded-full" style="width:${r.emotion * 10}%"></div>
              </div>
              <span class="text-sm font-medium">${r.emotion} åˆ†</span>
            </div>
          </div>
        `;
      }

      // å¯¼å‡º CSVï¼ˆæ€ç»´è®°å½•ï¼‰
      document.getElementById("btnExportCSV").addEventListener("click", () => {
        const { records } = loadDB();
        if (!records.length) return showToast("æš‚æ— æ•°æ®å¯å¯¼å‡º");
        const header = ["æ—¶é—´", "æƒ…å¢ƒ", "æƒ³æ³•", "è¯æ®", "æƒ…ç»ªå¼ºåº¦"];
        const rows = records.map((r) => [fmtTime(r.ts), r.context, r.thought.replace(/\n/g, " "), (r.evidence || "").replace(/\n/g, " "), r.emotion]);
        const csv = [header, ...rows].map((r) => r.map((x) => `"${(x + "").replace(/"/g, '""')}"`).join(",")).join("\n");
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "mindfit_thought_records.csv";
        a.click();
        URL.revokeObjectURL(url);
      });

      // æ‰“å°ä¸º PDFï¼ˆæµè§ˆå™¨ç«¯ï¼‰
      document.getElementById("btnPrint").addEventListener("click", () => {
        const win = window.open("", "_blank");
        const { records } = loadDB();
        win.document.write(`<html><head><title>æ€ç»´è®°å½•æ‰“å°</title></head><body><h2>æ€ç»´è®°å½•</h2>`);
        if (!records.length) {
          win.document.write("<p>æš‚æ— è®°å½•</p>");
        } else {
          records.forEach((r) => {
            win.document.write(`<div style="margin:12px 0;padding:12px;border:1px solid #eee">
              <div><b>æ—¶é—´ï¼š</b>${fmtTime(r.ts)}</div>
              <div><b>æƒ…å¢ƒï¼š</b>${r.context}</div>
              <div><b>æƒ³æ³•ï¼š</b>${r.thought.replace(/\n/g, "<br/>")}</div>
              <div><b>è¯æ®ï¼š</b>${(r.evidence || "").replace(/\n/g, "<br/>")}</div>
              <div><b>æƒ…ç»ªå¼ºåº¦ï¼š</b>${r.emotion} åˆ†</div>
            </div>`);
          });
        }
        win.document.write(`</body></html>`);
        win.document.close();
        win.focus();
      /*****************
       * æƒ…ç»ªç»ƒä¹ 
       *****************/
      document.querySelectorAll(".complete-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const card = btn.closest(".emotion-card");
          const cardId = card?.dataset?.card || "unknown";
          const db = loadDB();
          db.emotions.push({ card: cardId, ts: Date.now() });
          touchStreak(db);
          saveDB(db);
          unlockBadgesIfNeeded(db);
          renderEmotionStats();
          renderHome();

          // è§†è§‰æ ‡è®°
          card.classList.add("opacity-60");
          const sticker = card.querySelector(".done-sticker");
          if (sticker) sticker.classList.remove("hidden");
          btn.innerHTML = "å·²å®Œæˆ";
          btn.classList.remove("border-primary", "text-primary", "hover:bg-primary", "hover:text-white");
          btn.classList.add("border-gray-300", "text-gray-500", "bg-gray-100");
          showToast("å·²æ ‡è®°å®Œæˆï¼");
        });
      });

      function calcWeekStats(items) {
        const now = new Date();
        const startOfWeek = new Date(now);
        startOfWeek.setDate(now.getDate() - now.getDay()); // å‘¨æ—¥ä¸º 0
        const cnt = items.filter((x) => new Date(x.ts) >= startOfWeek).length;
        return cnt;
      }

      function renderEmotionStats() {
        const db = loadDB();
        const week = calcWeekStats(db.emotions);
        const total = db.emotions.length;
        document.getElementById("statWeek").textContent = `${Math.min(7, week)}/7`;
        document.getElementById("statTotal").textContent = total;
        document.getElementById("statStreak").textContent = db.streak.count;
        document.getElementById("statBar").style.width = `${Math.min(100, (week / 7) * 100)}%`;
      }

      function renderEmotionRecs() {
        const db = loadDB();
        const list = document.getElementById("emotionRecs");
        // ç®€å•æ¨èï¼šè‹¥æœ€è¿‘æƒ…ç»ªå¼ºåº¦>=7ï¼Œä¼˜å…ˆæ¨èå‘¼å¸ & æƒ…ç»ªå‘½åï¼›å¦åˆ™æ¨èæ­£å¿µé¥®é£Ÿ
        const lastTR = db.records.slice(-1)[0];
        const high = lastTR && lastTR.emotion >= 7;
        const recs = high
          ? [
              { title: "ç«‹åˆ»è¯•è¯• 4-2-6 å‘¼å¸", desc: "2 åˆ†é’Ÿå¿«é€Ÿç¨³å®šæƒ…ç»ª", tag: "åº”æ€¥", img: 21 },
              { title: "æƒ…ç»ªå‘½åæ¸…å•", desc: "ç»™æƒ…ç»ªä¸€ä¸ªåå­—å°±ä¼šå˜å°", tag: "æƒ…ç»ª", img: 22 },
            ]
          : [
              { title: "æ­£å¿µé¥®é£Ÿå…¥é—¨", desc: "ä»ä¸€é¢—è‘¡è„å¹²å¼€å§‹", tag: "æ­£å¿µ", img: 23 },
              { title: "èº«ä½“ä¸­ç«‹ 3 æ­¥", desc: "å…³æ³¨åŠŸèƒ½è€Œéå¤–è²Œ", tag: "ç†å¿µ", img: 24 },
            ];
        list.innerHTML = recs
          .map(
            (r) => `<div class="bg-white rounded-xl overflow-hidden card-shadow flex">
              <img src="https://picsum.photos/120/120?random=${r.img}" class="w-24 h-24 object-cover flex-shrink-0" alt="${r.title}">
              <div class="p-3 flex-grow">
                <h4 class="font-medium text-sm mb-1">${r.title}</h4>
                <p class="text-xs text-gray-500 mb-2 line-clamp-2">${r.desc}</p>
                <span class="badge bg-blue-50 text-primary">${r.tag}</span>
              </div>
            </div>`
          )
          .join("");
      }

      /*****************
       * è¡Œä¸ºå®éªŒ
       *****************/
      document.getElementById("btnSaveBX").addEventListener("click", () => {
        const db = loadDB();
        const item = {
          ts: Date.now(),
          belief: document.getElementById("bxBelief").value.trim(),
          steps: [document.getElementById("bxStep1").value.trim(), document.getElementById("bxStep2").value.trim(), document.getElementById("bxStep3").value.trim()].filter(Boolean),
          predict: document.getElementById("bxPredict").value.trim(),
          actual: document.getElementById("bxActual").value.trim(),
          learn: document.getElementById("bxLearn").value.trim(),
        };
        if (!item.belief) return showToast("è¯·å…ˆå¡«å†™æ‹…å¿§ä¿¡å¿µ");
        db.experiments.push(item);
        touchStreak(db);
        saveDB(db);
        unlockBadgesIfNeeded(db);
        renderBXList();
        showToast("å®éªŒå·²ä¿å­˜");
      });

      function renderBXList() {
        const db = loadDB();
        const box = document.getElementById("bxList");
        if (!db.experiments.length) {
          box.innerHTML = `<div class="text-sm text-gray-500">æš‚æ— è®°å½•</div>`;
          return;
        }
        box.innerHTML = db.experiments
          .slice(-3)
          .reverse()
          .map(
            (e) => `<div class="bg-white rounded-lg p-4 card-shadow">
            <div class="flex justify-between items-start mb-2">
              <h4 class="font-medium">å®éªŒï¼š${e.belief.slice(0, 16)}${e.belief.length > 16 ? "..." : ""}</h4>
              <span class="text-xs text-gray-500">${fmtTime(e.ts)}</span>
            </div>
            <p class="text-sm text-gray-600 line-clamp-2 mb-2">${e.predict ? "é¢„æµ‹ï¼š" + e.predict : ""}</p>
            <div class="flex justify-between items-center">
              <span class="badge bg-green-50 text-green-600">å·²ä¿å­˜</span>
            </div>
          </div>`
          )
          .join("");
      }

      // BMIè®¡ç®—åŠŸèƒ½
      document.getElementById('calculateBMI').addEventListener('click', () => {
        const height = parseFloat(document.getElementById('bmiHeight').value);
        const weight = parseFloat(document.getElementById('bmiWeight').value);
        const age = parseFloat(document.getElementById('bmiAge').value);
        const gender = document.querySelector('input[name="bmiGender"]:checked')?.value;

        if (!height || !weight || !age || !gender) {
          showToast('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
          return;
        }

        // è®¡ç®—BMI
        const bmi = weight / Math.pow(height / 100, 2);
        const bmiValue = bmi.toFixed(1);

        // ç¡®å®šBMIåˆ†ç±»
        let category, categoryClass, advice;
        
        if (bmi < 18.5) {
          category = 'åç˜¦';
          categoryClass = 'bg-blue-100 text-blue-800';
          advice = 'ä½“é‡å¯èƒ½åä½ï¼Œå»ºè®®å‡è¡¡é¥®é£Ÿï¼Œé€‚å½“å¢åŠ è¥å…»æ‘„å…¥ã€‚å…³æ³¨èº«ä½“èƒ½é‡å’Œå¥åº·çŠ¶æ€æ¯”å•çº¯å¢é‡æ›´é‡è¦ã€‚';
        } else if (bmi < 24) {
          category = 'æ­£å¸¸';
          categoryClass = 'bg-green-100 text-green-800';
          advice = 'æ­å–œï¼æ‚¨çš„BMIåœ¨æ­£å¸¸èŒƒå›´å†…ã€‚ç»§ç»­ä¿æŒå¥åº·çš„ç”Ÿæ´»æ–¹å¼ï¼Œå…³æ³¨èº«ä½“åŠŸèƒ½å’Œæ•´ä½“å¥åº·çŠ¶å†µã€‚';
        } else if (bmi < 28) {
          category = 'åé‡';
          categoryClass = 'bg-yellow-100 text-yellow-800';
          advice = 'å»ºè®®é€‚åº¦è°ƒæ•´é¥®é£Ÿç»“æ„å’Œå¢åŠ è¿åŠ¨ã€‚è®°ä½ï¼Œå¥åº·çš„èº«ä½“ä¸ä»…ä»…æ˜¯ä½“é‡æ•°å­—ï¼Œæ›´é‡è¦çš„æ˜¯æ•´ä½“çš„æ´»åŠ›å’ŒåŠŸèƒ½ã€‚';
        } else {
          category = 'è‚¥èƒ–';
          categoryClass = 'bg-red-100 text-red-800';
          advice = 'å»ºè®®å’¨è¯¢ä¸“ä¸šåŒ»ç”Ÿæˆ–è¥å…»å¸ˆï¼Œåˆ¶å®šä¸ªæ€§åŒ–çš„å¥åº·ç®¡ç†è®¡åˆ’ã€‚é‡è¦çš„æ˜¯å¾ªåºæ¸è¿›ï¼Œå…³çˆ±è‡ªå·±çš„èº«ä½“ã€‚';
        }

        // æ˜¾ç¤ºç»“æœ
        document.getElementById('bmiValue').textContent = bmiValue;
        document.getElementById('bmiCategory').textContent = category;
        document.getElementById('bmiCategory').className = `inline-block px-3 py-1 rounded-full text-sm font-medium ${categoryClass}`;
        document.getElementById('bmiAdvice').textContent = advice;
        document.getElementById('bmiResult').classList.remove('hidden');

        // ä¿å­˜æŒ‰é’®åŠŸèƒ½
        document.getElementById('saveBMI').onclick = () => {
          const db = loadDB();
          const bmiData = {
            ts: Date.now(),
            height,
            weight,
            age,
            gender,
            bmi: parseFloat(bmiValue),
            category,
            advice
          };
          
          if (!db.bmiAssessments) db.bmiAssessments = [];
          db.bmiAssessments.push(bmiData);
          saveDB(db);
          showToast('BMIç»“æœå·²ä¿å­˜');
          renderRecentAssessments();
        };
      });

      // èº«æç„¦è™‘æµ‹è¯„åŠŸèƒ½
      function initBodyAnxietyAssessment() {
        currentQuestion = 0;
        bodyAnxietyAnswers = [];
        showQuestion(0);
        updateProgress();
      }

      function showQuestion(index) {
        if (index >= BODY_ANXIETY_QUESTIONS.length) {
          completeBodyAnxietyAssessment();
          return;
        }

        document.getElementById('currentQuestionNum').textContent = index + 1;
        document.getElementById('questionText').textContent = BODY_ANXIETY_QUESTIONS[index];
        
        // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
        document.querySelectorAll('input[name="currentAnswer"]').forEach(input => {
          input.checked = false;
        });

        // å¦‚æœæœ‰ä¹‹å‰çš„ç­”æ¡ˆï¼Œæ˜¾ç¤º
        if (bodyAnxietyAnswers[index]) {
          document.querySelector(`input[name="currentAnswer"][value="${bodyAnxietyAnswers[index]}"]`).checked = true;
          document.getElementById('nextQuestion').disabled = false;
        } else {
          document.getElementById('nextQuestion').disabled = true;
        }

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.getElementById('prevQuestion').disabled = index === 0;
        document.getElementById('nextQuestion').textContent = 
          index === BODY_ANXIETY_QUESTIONS.length - 1 ? 'å®Œæˆæµ‹è¯„' : 'ä¸‹ä¸€é¢˜';
      }

      function updateProgress() {
        const progress = Math.round((currentQuestion / BODY_ANXIETY_QUESTIONS.length) * 100);
        document.getElementById('progressBar').style.width = `${progress}%`;
        document.getElementById('progressText').textContent = `${currentQuestion}/${BODY_ANXIETY_QUESTIONS.length}`;
      }

      // ç­”æ¡ˆé€‰æ‹©äº‹ä»¶
      document.querySelectorAll('.answer-option').forEach(option => {
        option.addEventListener('click', () => {
          const value = option.dataset.value;
          const radio = option.querySelector('input[type="radio"]');
          radio.checked = true;
          bodyAnxietyAnswers[currentQuestion] = parseInt(value);
          document.getElementById('nextQuestion').disabled = false;
        });
      });

      // å¯¼èˆªæŒ‰é’®äº‹ä»¶
      document.getElementById('prevQuestion').addEventListener('click', () => {
        if (currentQuestion > 0) {
          currentQuestion--;
          showQuestion(currentQuestion);
          updateProgress();
        }
      });

      document.getElementById('nextQuestion').addEventListener('click', () => {
        if (bodyAnxietyAnswers[currentQuestion]) {
          currentQuestion++;
          showQuestion(currentQuestion);
          updateProgress();
        }
      });

      function completeBodyAnxietyAssessment() {
        const totalScore = bodyAnxietyAnswers.reduce((sum, score) => sum + score, 0);
        const maxScore = BODY_ANXIETY_QUESTIONS.length * 4;
        const percentage = Math.round((totalScore / maxScore) * 100);

        // ç”Ÿæˆå»ºè®®
        const advice = generateBodyAnxietyAdvice(totalScore, percentage);

        // ä¿å­˜ç»“æœ
        const db = loadDB();
        if (!db.bodyAnxietyAssessments) db.bodyAnxietyAssessments = [];
        
        const assessmentData = {
          ts: Date.now(),
          answers: bodyAnxietyAnswers,
          totalScore,
          percentage,
          advice
        };
        
        db.bodyAnxietyAssessments.push(assessmentData);
        touchStreak(db);
        saveDB(db);
        renderRecentAssessments();

        // è·³è½¬åˆ°ç»“æœé¡µé¢
        const adviceStr = encodeURIComponent(advice.join(",,"));
        window.location.href = `result.html?advice=${adviceStr}`;
      }

      function generateBodyAnxietyAdvice(score, percentage) {
        const advice = [];
        
        if (percentage >= 75) {
          advice.push("â›ˆ é«˜åº¦ç„¦è™‘ï¼šä½ å½“å‰çš„èº«æç„¦è™‘ç¨‹åº¦è¾ƒé«˜ï¼Œå»ºè®®ä¼˜å…ˆè€ƒè™‘ä¸“ä¸šå¿ƒç†æ”¯æŒï¼Œé…åˆè‡ªæˆ‘è°ƒèŠ‚ç»ƒä¹ ã€‚");
      function generateBodyAnxietyAdvice(score, percentage) {
        const advice = [];
        
        if (percentage >= 75) {
          advice.push("â›ˆ é«˜åº¦ç„¦è™‘ï¼šä½ å½“å‰çš„èº«æç„¦è™‘ç¨‹åº¦è¾ƒé«˜ï¼Œå»ºè®®ä¼˜å…ˆè€ƒè™‘ä¸“ä¸šå¿ƒç†æ”¯æŒï¼Œé…åˆè‡ªæˆ‘è°ƒèŠ‚ç»ƒä¹ ã€‚");
          advice.push("ğŸ§˜ ä»Šæ—¥å°ä»»åŠ¡ï¼šè¿›è¡Œä¸€æ¬¡ 10 åˆ†é’Ÿçš„èº«ä½“æ‰«æå†¥æƒ³ï¼Œå…³æ³¨èº«ä½“çš„åŠŸèƒ½è€Œéå¤–è²Œã€‚");
        } else if (percentage >= 50) {
          advice.push("ğŸŒ§ ä¸­åº¦ç„¦è™‘ï¼šä½ å¯¹èº«ææœ‰ä¸€å®šç¨‹åº¦çš„ç„¦è™‘ï¼Œå»ºè®®å°è¯•èº«ä½“ä¸­ç«‹ç»ƒä¹ å’Œæ­£å¿µæŠ€å·§ã€‚");
          advice.push("ğŸ“ ä»Šæ—¥å°ä»»åŠ¡ï¼šå†™ä¸‹ 3 æ¡ä½ èº«ä½“çš„åŠŸèƒ½æ€§ä¼˜ç‚¹ï¼Œä¾‹å¦‚"æˆ‘çš„èº«ä½“è®©æˆ‘å¯ä»¥è‡ªç”±è¡Œèµ°"ã€‚");
        } else if (percentage >= 25) {
          advice.push("ğŸŒ¤ è½»åº¦ç„¦è™‘ï¼šä½ å¶å°”ä¼šå¯¹èº«ææ„Ÿåˆ°æ‹…å¿§ï¼Œè¿™å¾ˆæ­£å¸¸ã€‚å»ºè®®ä¿æŒç§¯æçš„èº«ä½“æ„è¯†ã€‚");
          advice.push("ğŸŒ¿ ä»Šæ—¥å°ä»»åŠ¡ï¼šæ¯æ—¥ 1 æ¬¡æ­£å¿µå‘¼å¸ï¼ˆçº¦ 3 åˆ†é’Ÿï¼‰ï¼Œå¹¶ç»ƒä¹ è‡ªæˆ‘è‚¯å®šè¯­ã€‚");
        } else {
          advice.push("ğŸŒŸ çŠ¶æ€è‰¯å¥½ï¼šä½ å¯¹èº«æä¿æŒç€å¥åº·çš„æ€åº¦ï¼Œç»§ç»­ä¿æŒè¿™ç§å¹³è¡¡çš„å¿ƒæ€ã€‚");
          advice.push("ğŸ’« ä»Šæ—¥å°ä»»åŠ¡ï¼šåˆ†äº«ä½ çš„ç§¯æå¿ƒæ€ï¼Œå¸®åŠ©èº«è¾¹çš„äººå»ºç«‹å¥åº·çš„èº«ä½“è§‚å¿µã€‚");
        }

        advice.push("ğŸ“˜ æ¨èé˜…è¯»: <a href='body-neutrality.html' target='_blank'>èº«ä½“ä¸­ç«‹å…¥é—¨æŒ‡å—</a> â€” å­¦ä¹ å¦‚ä½•å»ºç«‹æ›´å¥åº·çš„èº«ä½“å…³ç³»ã€‚");
        
        return advice;
      }

      function renderRecentAssessments() {
        const db = loadDB();
        const container = document.getElementById('recentAssessments');
        
        const bmiTests = (db.bmiAssessments || []).map(test => ({
          type: 'BMIæµ‹è¯„',
          ts: test.ts,
          result: `BMI: ${test.bmi} (${test.category})`
        }));
        
        const anxietyTests = (db.bodyAnxietyAssessments || []).map(test => ({
          type: 'èº«æç„¦è™‘è‡ªè¯„',
          ts: test.ts,
          result: `å¾—åˆ†: ${test.totalScore}/36 (${test.percentage}%)`
        }));
        
        const allTests = [...bmiTests, ...anxietyTests]
          .sort((a, b) => b.ts - a.ts)
          .slice(0, 3);

        if (allTests.length === 0) {
          container.innerHTML = '<div class="text-sm text-gray-500">æš‚æ— æµ‹è¯„è®°å½•</div>';
          return;
        }

        container.innerHTML = allTests.map(test => `
          <div class="flex items-center justify-between py-2 border-b border-gray-200 last:border-b-0">
            <div>
              <div class="text-sm font-medium text-gray-800">${test.type}</div>
              <div class="text-xs text-gray-500">${fmtTime(test.ts)}</div>
            </div>
            <div class="text-xs text-gray-600">${test.result}</div>
          </div>
        `).join('');
      }

      /*****************
       * è½»æµ‹è¯„ï¼ˆ9é¢˜ï¼‰
       *****************/
      const QUESTIONS = [
        "ç…§é•œå­æˆ–ç¿»çœ‹ç…§ç‰‡æ—¶ï¼Œæˆ‘ä¼šç‰¹åˆ«å…³æ³¨è‡ªå·±çš„æŸäº›èº«ä½“éƒ¨ä½",
        "æˆ‘ä¼šæŠŠè‡ªå·±å’Œç¤¾äº¤åª’ä½“ä¸Šçš„"å®Œç¾èº«æ"æ¯”è¾ƒ",
        "åƒå®Œå–œæ¬¢çš„é£Ÿç‰©åï¼Œæˆ‘ä¼šæ„Ÿåˆ°åæ‚”æˆ–æ„§ç–š",
        "å¦‚æœå¯¹è‡ªå·±çš„å¤–è²Œä¸æ»¡æ„ï¼Œæˆ‘ä¼šæƒ…ç»ªä½è½æˆ–å¿ƒæƒ…å—åˆ°å½±å“",
        "æˆ‘ä¼šç»™è‡ªå·±åˆ¶å®šä¸¥æ ¼çš„é¥®é£Ÿæˆ–è¿åŠ¨è®¡åˆ’ï¼Œè‹¥æœªå®Œæˆä¼šè‡ªè´£",
        "å› ä¸ºæ‹…å¿ƒèº«æï¼Œæˆ‘ä¼šé¿å…æ‹ç…§æˆ–å‚åŠ ç¤¾äº¤æ´»åŠ¨",
        "æˆ‘è§‰å¾—ç±»ä¼¼äº"å¦‚æœæˆ‘å˜å¾—æ›´å¥½çœ‹ï¼Œç”Ÿæ´»ä¼šæ›´é¡ºåˆ©"è¿™ç±»æƒ³æ³•æœ‰ä¸€å®šé“ç†",
        "æˆ‘æƒ³æ‘†è„±è¿™äº›ç„¦è™‘æƒ³æ³•ï¼Œä½†ä¸çŸ¥é“ä»å“ªé‡Œå¼€å§‹",
        "å¦‚æœæœ‰ç®€å•å¯æ“ä½œçš„å¿ƒç†è‡ªåŠ©ç»ƒä¹ ï¼ˆä¾‹å¦‚æ€ç»´è®°å½•ã€æƒ…ç»ªå¡ç‰‡ç­‰ï¼‰ï¼Œæˆ‘æ„¿æ„å°è¯•",
      ];

      function renderAssessment() {
        // BMI æ–‡æœ¬
        const h = document.getElementById("heightInput");
        const w = document.getElementById("weightInput");
        const bmiText = document.getElementById("bmiText");
        const updateBMI = () => {
          const hv = parseFloat(h.value) || 0;
          const wv = parseFloat(w.value) || 0;
          if (!hv || !wv) {
            bmiText.textContent = "";
            return;
          }
          const bmi = (wv / Math.pow(hv / 100, 2)).toFixed(1);
          let label = "åŠŸèƒ½å¥åº·è§’åº¦ï¼šå…³æ³¨èº«ä½“èƒ½åšä»€ä¹ˆï¼Œè€Œéæ•°å­—ã€‚";
          if (bmi < 18.5) label = "æç¤ºï¼šå¯èƒ½åç˜¦ï¼Œæ³¨æ„è¥å…»ä¸èƒ½é‡è¡¥å……ã€‚";
          else if (bmi < 24) label = "æç¤ºï¼šæ€»ä½“è‰¯å¥½ï¼Œç»§ç»­ä¿æŒå‡è¡¡ä¸è§‰å¯Ÿã€‚";
          else if (bmi < 28) label = "æç¤ºï¼šé€‚åº¦è°ƒæ•´é¥®é£Ÿä¸æ´»åŠ¨ï¼Œå¾ªåºæ¸è¿›ã€‚";
          else label = "æç¤ºï¼šå»ºè®®åœ¨ä¸“ä¸šæŒ‡å¯¼ä¸‹ç¨³æ­¥ç®¡ç†ä¸ç›‘æµ‹ã€‚";
          bmiText.textContent = `BMIâ‰ˆ${bmi}ã€‚${label}`;
        };
        h.oninput = updateBMI;
        w.oninput = updateBMI;

        // æ¸²æŸ“ 9 é¢˜
        const qList = document.getElementById("qList");
        if (!qList.dataset.rendered) {
          qList.innerHTML = QUESTIONS.map((q, i) => {
            return `<div>
                <label class="block text-sm text-gray-700 mb-1">${i + 1}. ${q}</label>
                <input type="range" min="1" max="5" value="3" class="w-full h-2 bg-gray-200 rounded-lg accent-primary assess-item" data-idx="${i}">
                <div class="flex justify-between text-xs text-gray-400"><span>1 ä»ä¸</span><span>5 æ€»æ˜¯</span></div>
              </div>`;
          }).join("");
          qList.dataset.rendered = "1";
        }
      }

      // é¦–æ¬¡è¿›å…¥ï¼Œæ¸²æŸ“é¦–é¡µ
      renderHome();
      renderTRPreview();

      // æ·»åŠ äº†è§£è‡ªå·±é¡µé¢å†…çš„å¯¼èˆªäº‹ä»¶
      document.addEventListener('click', (e) => {
        if (e.target.closest('[data-target="bmiAssessmentPage"]')) {
          navigateTo('bmiAssessmentPage');
        } else if (e.target.closest('[data-target="bodyAnxietyAssessmentPage"]')) {
          navigateTo('bodyAnxietyAssessmentPage');
        }
      });    <!-- äº†è§£è‡ªå·±é¡µé¢ -->
    <section id="selfAssessmentPage" class="page hidden">
      <div class="px-4 py-6">
        <div class="mb-6">
          <h2 class="text-xl font-bold mb-2">äº†è§£è‡ªå·±</h2>
          <p class="text-gray-500 text-sm">é€šè¿‡ç§‘å­¦æµ‹è¯„ï¼Œæ›´å¥½åœ°è®¤çŸ¥å½“ä¸‹çš„è‡ªå·±</p>
        </div>

        <!-- æµ‹è¯„å¡ç‰‡ç½‘æ ¼ -->
        <div class="space-y-4">
          <!-- BMIæµ‹è¯„å¡ç‰‡ -->
          <div class="bg-white rounded-xl p-6 card-shadow cursor-pointer hover:shadow-lg transition-all" data-target="bmiAssessmentPage">
            <div class="flex items-center">
              <div class="w-14 h-14 rounded-full bg-blue-100 flex items-center justify-center mr-4">
                <i class="ph ph-scales text-blue-500 text-2xl"></i>
              </div>
              <div class="flex-1">
                <h3 class="text-lg font-semibold text-gray-800 mb-1">BMI èº«ä½“æµ‹è¯„</h3>
                <p class="text-sm text-gray-500 mb-2">äº†è§£èº«ä½“çŠ¶å†µï¼Œå»ºç«‹å¥åº·è®¤çŸ¥</p>
                <div class="flex items-center text-xs text-gray-400">
                  <i class="fa fa-clock-o mr-1"></i>
                  <span>çº¦2åˆ†é’Ÿ</span>
                </div>
              </div>
              <i class="fa fa-chevron-right text-gray-300 text-lg"></i>
            </div>
          </div>

          <!-- èº«æç„¦è™‘è‡ªè¯„å¡ç‰‡ -->
          <div class="bg-white rounded-xl p-6 card-shadow cursor-pointer hover:shadow-lg transition-all" data-target="bodyAnxietyAssessmentPage">
            <div class="flex items-center">
              <div class="w-14 h-14 rounded-full bg-pink-100 flex items-center justify-center mr-4">
                <i class="ph ph-heart text-pink-500 text-2xl"></i>
              </div>
              <div class="flex-1">
                <h3 class="text-lg font-semibold text-gray-800 mb-1">èº«æç„¦è™‘è‡ªè¯„</h3>
                <p class="text-sm text-gray-500 mb-2">9é¢˜é‡è¡¨ï¼Œè¯„ä¼°èº«æç„¦è™‘ç¨‹åº¦</p>
                <div class="flex items-center text-xs text-gray-400">
                  <i class="fa fa-clock-o mr-1"></i>
                  <span>çº¦3åˆ†é’Ÿ</span>
                </div>
              </div>
              <i class="fa fa-chevron-right text-gray-300 text-lg"></i>
            </div>
          </div>

          <!-- å†å²è®°å½• -->
          <div class="bg-gray-50 rounded-xl p-4">
            <h4 class="text-sm font-medium text-gray-700 mb-3">æœ€è¿‘æµ‹è¯„</h4>
            <div id="recentAssessments" class="space-y-2">
              <div class="text-sm text-gray-500">æš‚æ— æµ‹è¯„è®°å½•</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- BMIæµ‹è¯„é¡µé¢ -->
    <section id="bmiAssessmentPage" class="page hidden">
      <div class="px-4 py-6">
        <div class="mb-6">
          <h2 class="text-xl font-bold mb-2">BMI èº«ä½“æµ‹è¯„</h2>
          <p class="text-gray-500 text-sm">äº†è§£åŸºç¡€èº«ä½“æŒ‡æ ‡ï¼Œå»ºç«‹å¥åº·çš„èº«ä½“è®¤çŸ¥</p>
        </div>

        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="bg-white rounded-xl p-6 card-shadow mb-6">
          <h3 class="text-lg font-semibold mb-4">åŸºç¡€ä¿¡æ¯</h3>
          
          <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">èº«é«˜ (cm)</label>
                <input id="bmiHeight" type="number" min="80" max="230" 
                       class="w-full p-3 border border-gray-200 rounded-lg focus:border-primary focus:ring-1 focus:ring-primary outline-none" 
                       placeholder="165" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ä½“é‡ (kg)</label>
                <input id="bmiWeight" type="number" min="20" max="250" step="0.1"
                       class="w-full p-3 border border-gray-200 rounded-lg focus:border-primary focus:ring-1 focus:ring-primary outline-none" 
                       placeholder="55.5" />
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">å¹´é¾„</label>
              <input id="bmiAge" type="number" min="10" max="100" 
                     class="w-full p-3 border border-gray-200 rounded-lg focus:border-primary focus:ring-1 focus:ring-primary outline-none" 
                     placeholder="25" />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">æ€§åˆ«</label>
              <div class="flex space-x-4">
                <label class="flex items-center">
                  <input type="radio" name="bmiGender" value="female" class="mr-2 text-primary">
                  <span>å¥³æ€§</span>
                </label>
                <label class="flex items-center">
                  <input type="radio" name="bmiGender" value="male" class="mr-2 text-primary">
                  <span>ç”·æ€§</span>
                </label>
              </div>
            </div>
          </div>

          <button id="calculateBMI" class="w-full mt-6 py-3 bg-primary text-white rounded-lg font-medium hover:bg-primary/90 transition-colors">
            <i class="fa fa-calculator mr-2"></i>è®¡ç®— BMI
          </button>
        </div>

        <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
        <div id="bmiResult" class="hidden bg-white rounded-xl p-6 card-shadow mb-6">
          <h3 class="text-lg font-semibold mb-4">æµ‹è¯„ç»“æœ</h3>
          
          <div class="text-center mb-6">
            <div class="text-3xl font-bold text-primary mb-2" id="bmiValue">--</div>
            <div class="text-sm text-gray-500 mb-4">æ‚¨çš„BMIæŒ‡æ•°</div>
            <div class="inline-block px-3 py-1 rounded-full text-sm font-medium" id="bmiCategory">
              <!-- åŠ¨æ€æ˜¾ç¤ºåˆ†ç±» -->
            </div>
          </div>

          <div class="space-y-4">
            <div class="bg-blue-50 rounded-lg p-4">
              <h4 class="font-medium text-blue-800 mb-2">å¥åº·å»ºè®®</h4>
              <p id="bmiAdvice" class="text-sm text-blue-700">
                <!-- åŠ¨æ€æ˜¾ç¤ºå»ºè®® -->
              </p>
            </div>

            <div class="bg-yellow-50 rounded-lg p-4">
              <h4 class="font-medium text-yellow-800 mb-2">èº«ä½“ä¸­ç«‹æé†’</h4>
              <p class="text-sm text-yellow-700">
                BMIåªæ˜¯ä¸€ä¸ªå‚è€ƒæŒ‡æ ‡ï¼Œä¸èƒ½å®Œå…¨åæ˜ å¥åº·çŠ¶å†µã€‚é‡è¦çš„æ˜¯å…³æ³¨èº«ä½“çš„åŠŸèƒ½å’Œæ„Ÿå—ï¼Œè€Œä¸ä»…ä»…æ˜¯æ•°å­—ã€‚
              </p>
            </div>
          </div>

          <button id="saveBMI" class="w-full mt-4 py-3 bg-secondary text-white rounded-lg font-medium hover:bg-secondary/90 transition-colors">
            <i class="fa fa-save mr-2"></i>ä¿å­˜ç»“æœ
          </button>
        </div>
      </div>
    </section>

    <!-- èº«æç„¦è™‘è‡ªè¯„é¡µé¢ -->
    <section id="bodyAnxietyAssessmentPage" class="page hidden">
      <div class="px-4 py-6">
        <div class="mb-6">
          <h2 class="text-xl font-bold mb-2">èº«æç„¦è™‘è‡ªè¯„</h2>
          <p class="text-gray-500 text-sm">é€šè¿‡9é“é¢˜ç›®ï¼Œäº†è§£ä½ å¯¹èº«ä½“å½¢è±¡çš„æ„Ÿå—</p>
        </div>

        <!-- è¿›åº¦æŒ‡ç¤ºå™¨ -->
        <div class="bg-white rounded-xl p-4 card-shadow mb-6">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium text-gray-700">ç­”é¢˜è¿›åº¦</span>
            <span id="progressText" class="text-sm text-primary">0/9</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div id="progressBar" class="bg-primary h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
          </div>
        </div>

        <!-- é¢˜ç›®å¡ç‰‡ -->
        <div id="questionCard" class="bg-white rounded-xl p-6 card-shadow mb-6">
          <div class="mb-4">
            <span class="text-sm text-gray-500">ç¬¬ <span id="currentQuestionNum">1</span> é¢˜</span>
          </div>
          
          <h3 id="questionText" class="text-lg font-medium text-gray-800 mb-6 leading-relaxed">
            <!-- åŠ¨æ€æ˜¾ç¤ºé¢˜ç›® -->
          </h3>

          <div class="space-y-3">
            <div class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:border-primary hover:bg-blue-50 transition-all answer-option" data-value="1">
              <input type="radio" name="currentAnswer" value="1" class="mr-3 text-primary">
              <span>å®Œå…¨ä¸åŒæ„</span>
            </div>
            <div class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:border-primary hover:bg-blue-50 transition-all answer-option" data-value="2">
              <input type="radio" name="currentAnswer" value="2" class="mr-3 text-primary">
              <span>ä¸å¤ªåŒæ„</span>
            </div>
            <div class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:border-primary hover:bg-blue-50 transition-all answer-option" data-value="3">
              <input type="radio" name="currentAnswer" value="3" class="mr-3 text-primary">
              <span>æœ‰äº›åŒæ„</span>
            </div>
            <div class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:border-primary hover:bg-blue-50 transition-all answer-option" data-value="4">
              <input type="radio" name="currentAnswer" value="4" class="mr-3 text-primary">
              <span>éå¸¸åŒæ„</span>
            </div>
          </div>
        </div>

        <!-- å¯¼èˆªæŒ‰é’® -->
        <div class="flex space-x-3">
          <button id="prevQuestion" class="flex-1 py-3 border border-gray-300 text-gray-600 rounded-lg font-medium hover:bg-gray-50 transition-colors" disabled>
            <i class="fa fa-chevron-left mr-2"></i>ä¸Šä¸€é¢˜
          </button>
          <button id="nextQuestion" class="flex-1 py-3 bg-primary text-white rounded-lg font-medium hover:bg-primary/90 transition-colors" disabled>
            ä¸‹ä¸€é¢˜<i class="fa fa-chevron-right ml-2"></i>
          </button>
        </div>
      </div>
    </section>

    <!-- èº«å¿ƒè½»æµ‹è¯„ -->
    <section id="assessmentPage" class="page hidden">


