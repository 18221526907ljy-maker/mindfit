/*****************
       * 冥想/正念
       *****************/
      const audio = document.getElementById("audio");
      const playBtn = document.getElementById("playPauseBtn");
      const playIcon = document.getElementById("playPauseIcon");
      const seekBar = document.getElementById("seekBar");
      const vol = document.getElementById("volumeBar");
      const cur = document.getElementById("currentTime");
      const total = document.getElementById("totalTime");

      let timerId = null;

      function updateTimeDisplay(sec) {
        const m = String(Math.floor(sec / 60)).padStart(2, "0");
        const s = String(Math.floor(sec % 60)).padStart(2, "0");
        return `${m}:${s}`;
      }

      function setTotal(sec) {
        total.textContent = updateTimeDisplay(sec);
        seekBar.max = String(sec);
      }

      setTotal(180); // 默认 3 分钟

      // Audio controls（可选）
      playBtn.addEventListener("click", () => {
        if (audio.paused) {
          audio.play().catch(() => {});
          playBtn.innerHTML = '<i class="fa fa-pause"></i>';
          playIcon.className = "fa fa-pause text-white text-3xl";
        } else {
          audio.pause();
          playBtn.innerHTML = '<i class="fa fa-play"></i>';
          playIcon.className = "fa fa-play text-white text-3xl";
        }
      });
      audio.addEventListener("timeupdate", () => {
        seekBar.value = Math.floor(audio.currentTime);
        cur.textContent = updateTimeDisplay(audio.currentTime);
      });
      seekBar.addEventListener("input", () => (audio.currentTime = Number(seekBar.value)));
      vol.addEventListener("input", () => (audio.volume = Number(vol.value)));

      // 计时练习
      document.getElementById("startPracticeBtn").addEventListener("click", () => {
        let sec = 0;
        clearInterval(timerId);
        timerId = setInterval(() => {
          sec += 1;
          cur.textContent = updateTimeDisplay(sec);
          seekBar.value = sec;
          if (sec >= 180) {
            clearInterval(timerId);
            const db = loadDB();
            db.mindfulness.push({ seconds: sec, ts: Date.now() });
            touchStreak(db);
            saveDB(db);
            unlockBadgesIfNeeded(db);
            renderHome();
            showToast("练习完成，已记录 3 分钟");
          }
        }, 1000);
      });

      document.getElementById("btnStepBack").addEventListener("click", () => (audio.currentTime = Math.max(0, audio.currentTime - 5)));
      document.getElementById("btnStepForward").addEventListener("click", () => (audio.currentTime = Math.min(Number(seekBar.max), audio.currentTime + 5)));

      document.getElementById("btnCache").addEventListener("click", () => {
        const db = loadDB();
        db.cachedAudio = true;
        saveDB(db);
        showToast("已记为离线可用提示（示例）");
      });

      /*****************
       * 我的记录列表 & 导出
       *****************/
      document.querySelectorAll(".filter-btn").forEach((b) =>
        b.addEventListener("click", () => {
          document.querySelectorAll(".filter-btn").forEach((x) => x.classList.replace("bg-primary", "bg-gray-100"));
          document.querySelectorAll(".filter-btn").forEach((x) => x.classList.replace("text-white", "text-gray-600"));
          b.classList.replace("bg-gray-100", "bg-primary");
          b.classList.replace("text-gray-600", "text-white");
          renderRecordList(b.dataset.filter);
        })
      );

      function renderRecordList(filter = "all") {
        const db = loadDB();
        const box = document.getElementById("recordList");
        let items = [];

        if (filter === "all" || filter === "thought") {
          items = items.concat(db.records.map((r) => ({ type: "thought", ts: r.ts, data: r })));
        }
        if (filter === "all" || filter === "emotion") {
      function renderRecordList(filter = "all") {
        const db = loadDB();
        const box = document.getElementById("recordList");
        let items = [];

        if (filter === "all" || filter === "thought") {
          items = items.concat(db.records.map((r) => ({ type: "thought", ts: r.ts, data: r })));
        }
        if (filter === "all" || filter === "emotion") {
          items = items.concat(db.emotions.map((e) => ({ type: "emotion", ts: e.ts, data: e })));
        }
        if (filter === "all" || filter === "experiment") {
          items = items.concat(db.experiments.map((e) => ({ type: "experiment", ts: e.ts, data: e })));
        }
        if (filter === "all" || filter === "mindfulness") {
          items = items.concat(db.mindfulness.map((m) => ({ type: "mindfulness", ts: m.ts, data: m })));
        }
        if (filter === "all" || filter === "assessment") {
          items = items.concat(db.assessments.map((a) => ({ type: "assessment", ts: a.ts, data: a })));
        }

        items.sort((a, b) => b.ts - a.ts);

        if (!items.length) {
          box.innerHTML = `<div class="text-sm text-gray-500">暂无记录</div>`;
          return;
        }

        box.innerHTML = items
          .map((it) => {
            if (it.type === "thought") {
              const r = it.data;
              return `<div class="bg-white rounded-lg p-4 card-shadow">
                <div class="flex justify-between items-start mb-2">
                  <div class="flex items-center">
                    <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mr-2">
                      <i class="fa fa-pencil text-primary text-sm"></i>
                    </div>
                    <h4 class="font-medium">自动思维记录</h4>
                  </div>
                  <span class="text-xs text-gray-500">${fmtTime(it.ts)}</span>
                </div>
                <p class="text-sm text-gray-600 line-clamp-2 mb-3">情境：${r.context}… 情绪强度：${r.emotion}分</p>
                <span class="badge bg-blue-50 text-primary">思维</span>
              </div>`;
            }
            if (it.type === "emotion") {
              return `<div class="bg-white rounded-lg p-4 card-shadow">
                <div class="flex justify-between items-start mb-2">
                  <div class="flex items-center">
                    <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center mr-2">
                      <i class="fa fa-heart-o text-secondary text-sm"></i>
                    </div>
                    <h4 class="font-medium">情绪练习完成</h4>
                  </div>
                  <span class="text-xs text-gray-500">${fmtTime(it.ts)}</span>
                </div>
                <p class="text-sm text-gray-600 mb-2">练习：${it.data.card}</p>
                <span class="badge bg-green-50 text-secondary">练习</span>
              </div>`;
            }
            if (it.type === "experiment") {
              const e = it.data;
              return `<div class="bg-white rounded-lg p-4 card-shadow">
                <div class="flex justify-between items-start mb-2">
                  <div class="flex items-center">
                    <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center mr-2">
                      <i class="fa fa-flask text-accent text-sm"></i>
                    </div>
                    <h4 class="font-medium">行为实验</h4>
                  </div>
                  <span class="text-xs text-gray-500">${fmtTime(it.ts)}</span>
                </div>
                <p class="text-sm text-gray-600 line-clamp-2 mb-2">${e.belief}</p>
                <span class="badge bg-purple-50 text-purple-600">实验</span>
              </div>`;
            }
            if (it.type === "mindfulness") {
              return `<div class="bg-white rounded-lg p-4 card-shadow">
                <div class="flex justify-between items-start mb-2">
                  <div class="flex items-center">
                    <div class="w-8 h-8 rounded-full bg-yellow-100 flex items-center justify-center mr-2">
                      <i class="fa fa-headphones text-yellow-500 text-sm"></i>
                    </div>
                    <h4 class="font-medium">冥想练习</h4>
                  </div>
                  <span class="text-xs text-gray-500">${fmtTime(it.ts)}</span>
                </div>
                <p class="text-sm text-gray-600 mb-2">时长：${Math.round(it.data.seconds / 60)} 分钟</p>
                <span class="badge bg-yellow-50 text-yellow-600">冥想</span>
              </div>`;
            }
            if (it.type === "assessment") {
              return `<div class="bg-white rounded-lg p-4 card-shadow">
                <div class="flex justify-between items-start mb-2">
                  <div class="flex items-center">
                    <div class="w-8 h-8 rounded-full bg-pink-100 flex items-center justify-center mr-2">
                      <i class="fa fa-question-circle text-pink-500 text-sm"></i>
                    </div>
                    <h4 class="font-medium">身心轻测评</h4>
                  </div>
                  <span class="text-xs text-gray-500">${fmtTime(it.ts)}</span>
                </div>
                <p class="text-sm text-gray-600 mb-2">总分：${it.data.score}（9~45）</p>
                <span class="badge bg-pink-50 text-pink-600">测评</span>
              </div>`;
            }
          })
          .join("");
      }

      // 导出所有 CSV
      document.getElementById("btnExportAll").addEventListener("click", () => {
        const db = loadDB();
        const combine = [];
        db.records.forEach((r) => combine.push(["思维记录", fmtTime(r.ts), r.context, r.thought.replace(/\n/g, " "), (r.evidence || "").replace(/\n/g, " "), r.emotion]));
        db.emotions.forEach((e) => combine.push(["情绪练习", fmtTime(e.ts), e.card, "", "", ""]));
        db.experiments.forEach((e) => combine.push(["行为实验", fmtTime(e.ts), e.belief.replace(/\n/g, " "), (e.predict || "").replace(/\n/g, " "), (e.actual || "").replace(/\n/g, " "), ""]));
        db.mindfulness.forEach((m) => combine.push(["冥想", fmtTime(m.ts), `时长${Math.round(m.seconds / 60)}分钟`, "", "", ""]));
        db.assessments.forEach((a) => combine.push(["测评", fmtTime(a.ts), `总分${a.score}`, "", "", ""]));
        if (!combine.length) return showToast("暂无数据可导出");

        const header = ["类型", "时间", "A", "B", "C", "D"];
        const csv = [header, ...combine].map((r) => r.map((x) => `"${(x + "").replace(/"/g, '""')}"`).join(",")).join("\n");
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = "mindfit_all_records.csv"; a.click();
        URL.revokeObjectURL(url);
      });

      // 清空数据
      document.getElementById("btnClearAll").addEventListener("click", () => {
        if (!confirm("确定要清空所有本地数据吗？此操作不可恢复。")) return;
        localStorage.removeItem(DB_KEY);
        showToast("已清空本地数据");
        renderHome();
        renderRecordList("all");
        renderBadges();
      });

      /*****************
       * 徽章系统
       *****************/
      const BADGE_RULES = [
        { id: "tr_3", name: "思维记录者", icon: "fa-pencil", color: "text-primary", desc: "完成 3 次自动思维记录", check: (db) => db.records.length >= 3 },
        { id: "emo_5", name: "情绪调节新手", icon: "fa-heart-o", color: "text-secondary", desc: "完成 5 次情绪练习", check: (db) => db.emotions.length >= 5 },
        { id: "streak_7", name: "坚持者", icon: "fa-calendar-check-o", color: "text-accent", desc: "连续 7 天使用", check: (db) => db.streak.count >= 7 },
      ];

      function unlockBadgesIfNeeded(db) {
        let unlockedName = null;
        BADGE_RULES.forEach((b) => {
          if (b.check(db) && !db.badges[b.id]) {
            db.badges[b.id] = true;
            unlockedName = b.name;
          }
        });
        saveDB(db);
        if (unlockedName) {
          const banner = document.getElementById("badgeBanner");
          const text = document.getElementById("badgeBannerText");
          text.textContent = unlockedName;
          banner.classList.remove("hidden");
          setTimeout(() => banner.classList.add("hidden"), 3200);
        }
      }

      function renderBadges() {
        const db = loadDB();
        const unlocked = document.getElementById("badgeUnlocked");
        const locked = document.getElementById("badgeLocked");
        const renderCard = (b, dim = false) => `
          <div class="badge-card bg-white rounded-xl p-4 card-shadow flex flex-col items-center ${dim ? 'opacity-50' : ''}">
            <div class="w-16 h-16 rounded-full ${dim ? 'bg-gray-100' : 'bg-blue-100'} flex items-center justify-center mb-2">
              <i class="fa ${b.icon} ${b.color} text-2xl"></i>
            </div>
            <h4 class="text-sm font-medium text-center mb-1">${b.name}</h4>
            <p class="text-xs text-gray-500 text-center mb-2">${b.desc}</p>
          </div>`;
        unlocked.innerHTML = BADGE_RULES.filter((b) => db.badges[b.id]).map((b) => renderCard(b)).join("") || `<div class="text-sm text-gray-500">暂无</div>`;
        locked.innerHTML = BADGE_RULES.filter((b) => !db.badges[b.id]).map((b) => renderCard(b, true)).join("") || `<div class="text-sm text-gray-500">全部解锁啦 🎉</div>`;
      }

      /*****************
       * 首页渲染（进度/最近/推荐）
       *****************/
      function renderHome() {
        const db = loadDB();
        // 进度：粗略用各模块完成量合成
        const total = db.records.length + db.emotions.length + db.mindfulness.length + db.experiments.length + db.assessments.length;
        const percent = Math.max(5, Math.min(100, Math.round((total / 20) * 100))); // 20 次完成≈满进度
        document.getElementById("progressBar").style.width = `${percent}%`;

        // 最近记录：取最近 2 条（思维/练习/冥想/实验/测评混排）
        const recentBox = document.getElementById("recentList");
        const all = []
          .concat(db.records.map((r) => ({ type: "thought", ts: r.ts, tag: "思维", icon: "fa-pencil", color: "text-primary" })))
          .concat(db.emotions.map((e) => ({ type: "emotion", ts: e.ts, tag: "练习", icon: "fa-heart-o", color: "text-secondary" })))
          .concat(db.mindfulness.map((m) => ({ type: "mindfulness", ts: m.ts, tag: "冥想", icon: "fa-headphones", color: "text-yellow-500" })))
          .concat(db.experiments.map((m) => ({ type: "experiment", ts: m.ts, tag: "实验", icon: "fa-flask", color: "text-accent" })))
          .concat(db.assessments.map((a) => ({ type: "assessment", ts: a.ts, tag: "测评", icon: "fa-question-circle", color: "text-pink-500" })));
        all.sort((a, b) => b.ts - a.ts);
        const slice = all.slice(0, 2);
        if (!slice.length) {
          recentBox.innerHTML = `<div class="text-sm text-gray-500">暂无记录，先去试试上方的工具卡片吧～</div>`;
        } else {
          recentBox.innerHTML = slice
            .map(
              (x) => `<div class="bg-white rounded-lg p-4 card-shadow flex items-center justify-between">
                <div class="flex items-center">
                  <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center mr-3">
                    <i class="fa ${x.icon} ${x.color}"></i>
                  </div>
                  <div>
                    <p class="font-medium">${x.tag}记录</p>
                    <p class="text-sm text-gray-500">${fmtTime(x.ts)}</p>
                  </div>
                </div>
                <span class="text-xs bg-gray-50 text-gray-600 px-2 py-1 rounded-full">${x.tag}</span>
              </div>`
            )
            .join("");
        }

        // 推荐内容：根据最近一次情绪强度
        const recBox = document.getElementById("recommendList");
        const last = db.records.slice(-1)[0];
        const items =
          last && last.emotion >= 7
            ? [
                { img: 31, title: "焦虑时的 90 秒方法", desc: "识别情绪→深呼吸→放松扫描" },
                { img: 32, title: "两分钟自我肯定语", desc: "写下 3 条身体功能感恩" },
              ]
            : [
                { img: 33, title: "身体中立入门", desc: "从功能与健康角度看待身体" },
                { img: 34, title: "正念饮食 5 步", desc: "慢一点，和味道好好相处" },
              ];
        recBox.innerHTML = items
          .map(
            (r) => `<div class="bg-white rounded-xl overflow-hidden card-shadow">
              <img src="https://picsum.photos/400/200?random=${r.img}" alt="${r.title}" class="w-full h-40 object-cover">
              <div class="p-4">
                <h4 class="font-semibold mb-1">${r.title}</h4>
                <p class="text-sm text-gray-500 mb-3 line-clamp-2">${r.desc}</p>
                <div class="flex items-center justify-between">
                  <span class="text-xs text-gray-400">2 分钟阅读</span>
                  <button onclick="location.href='body-neutrality.html'">查看</button>
                </div>
              </div>
            </div>`
          )
          .join("");
      }

      // 首次进入，渲染首页
      renderHome();
      renderTRPreview();
    });

    const items = [
      {
        title: "身体中立入门",
        desc: "从功能与健康角度看待身体",
        img: 1,
        link: "body-neutrality.html"
      },
      {
        title: "正念饮食 5 步",
        desc: "慢一点，和味道好好相处",
        img: 2,
        link: "mindful-eating.html"
      },
      {
        title: "焦虑舒缓小练习",
        desc: "3 分钟调节身体紧绷，回归此刻",
        img: 3,
        link: "quick-anxiety-relief.html"
      }
    ];

    const recBox = document.getElementById("recommendList");

    recBox.innerHTML = items
      .map((r) => `
        <div class="bg-white rounded-xl overflow-hidden card-shadow">
          <img src="https://picsum.photos/400/200?random=${r.img}" alt="${r.title}" class="w-full h-40 object-cover">
          <div class="p-4">
            <h4 class="font-semibold mb-1">${r.title}</h4>
            <p class="text-sm text-gray-500 mb-3 line-clamp-2">${r.desc}</p>
            <div class="flex items-center justify-between">
              <span class="text-xs text-gray-400">2 分钟阅读</span>
            </div>
          </div>
        </div>
      `)
      .join("");

  </script>
</body>
</html>  <script>
    /*****************
     * 基础工具 & 存储
     *****************/
    const DB_KEY = "mindfit_db_v1";

    const defaultDB = () => ({
      records: [],          // 思维记录
      emotions: [],         // 情绪练习完成 {card, ts}
      experiments: [],      // 行为实验
      mindfulness: [],      // 冥想练习 {seconds, ts}
      assessments: [],      // 测评结果
      bmiAssessments: [],   // BMI测评结果
      bodyAnxietyAssessments: [], // 身材焦虑测评结果
      badges: {},           // 徽章布尔
      streak: { count: 0, lastDate: "" }, // 连续天数
      cachedAudio: false,   // 冥想音频缓存标记（提示用）
    });

    const loadDB = () => {
      try {
        const raw = localStorage.getItem(DB_KEY);
        return raw ? JSON.parse(raw) : defaultDB();
      } catch (e) {
        return defaultDB();
      }
    };

    const saveDB = (db) => localStorage.setItem(DB_KEY, JSON.stringify(db));

    const todayStr = () => {
      const d = new Date();
      return d.toISOString().slice(0, 10);
    };

    const fmtTime = (ts) => {
      const d = new Date(ts);
      const pad = (n) => (n < 10 ? "0" + n : n);
      return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    };

    const showToast = (msg) => {
      const wrap = document.getElementById("toast");
      const box = wrap.firstElementChild;
      box.textContent = msg;
      wrap.classList.remove("hidden");
      setTimeout(() => wrap.classList.add("hidden"), 1800);
    };

    // streak 更新：每天任意操作一次记为活跃
    const touchStreak = (db) => {
      const t = todayStr();
      if (db.streak.lastDate === t) return;
      // 判断是否连续
      const last = db.streak.lastDate ? new Date(db.streak.lastDate) : null;
      const y = new Date(t);
      const one = 24 * 60 * 60 * 1000;
      const isConsecutive = last && (y - last) / one === 1;
      db.streak.count = isConsecutive ? (db.streak.count + 1) : 1;
      db.streak.lastDate = t;
    };

    /*****************
     * 页面导航
     *****************/
    document.addEventListener("DOMContentLoaded", () => {
      const pages = document.querySelectorAll(".page");
      const backBtn = document.getElementById("backBtn");
      const pageTitle = document.getElementById("pageTitle");
      const featureCards = document.querySelectorAll(".feature-card");
      const otherLinks = document.querySelectorAll("[data-target]");
      const navBtns = document.querySelectorAll(".nav-btn");

      let pageHistory = ["homePage"];

      const titleMap = {
        homePage: "MindFit 身心管理",
        selfAssessmentPage: "了解自己",
        bmiAssessmentPage: "BMI 身体测评",
        bodyAnxietyAssessmentPage: "身材焦虑自评",
        assessmentPage: "身心轻测评",
        thoughtRecordPage: "自动思维记录",
        emotionRegulationPage: "情绪调节卡片",
        behaviorExperimentPage: "行为实验指南",
        mindfulnessPage: "冥想/正念练习",
        myRecordsPage: "我的记录",
        myBadgesPage: "我的徽章",
      };

      // 全局导航函数
      window.navigateToSelfAssessment = function() {
        navigateTo('selfAssessmentPage');
      };

      // 身材焦虑测评题目（复用现有的9题）
      const BODY_ANXIETY_QUESTIONS = [
        "照镜子或翻看照片时，我会特别关注自己的某些身体部位",
        "我会把自己和社交媒体上的"完美身材"比较",
        "吃完喜欢的食物后，我会感到后悔或愧疚",
        "如果对自己的外貌不满意，我会情绪低落或心情受到影响",
        "我会给自己制定严格的饮食或运动计划，若未完成会自责",
        "因为担心身材，我会避免拍照或参加社交活动",
        "我觉得类似于"如果我变得更好看，生活会更顺利"这类想法有一定道理",
        "我想摆脱这些焦虑想法，但不知道从哪里开始",
        "如果有简单可操作的心理自助练习（例如思维记录、情绪卡片等），我愿意尝试",
      ];

      let currentQuestion = 0;
      let bodyAnxietyAnswers = [];

      function navigateTo(id) {
        pages.forEach((p) => p.classList.add("hidden"));
        const target = document.getElementById(id);
        if (!target) return;
        target.classList.remove("hidden");
        pageTitle.textContent = titleMap[id] || "MindFit";
        if (pageHistory[pageHistory.length - 1] !== id) pageHistory.push(id);
        window.scrollTo(0, 0);
        
        // 进入页面时渲染
        switch (id) {
          case "homePage":
            renderHome();
            break;
          case "selfAssessmentPage":
            renderRecentAssessments();
            break;
          case "bodyAnxietyAssessmentPage":
            initBodyAnxietyAssessment();
            break;
          case "thoughtRecordPage":
            renderTRPreview();
            break;
          case "emotionRegulationPage":
            renderEmotionStats();
            renderEmotionRecs();
            break;
          case "behaviorExperimentPage":
            renderBXList();
            break;
          case "myRecordsPage":
            renderRecordList("all");
            break;
          case "myBadgesPage":
            renderBadges();
            break;
          case "assessmentPage":
            renderAssessment();
            break;
        }
      }

      featureCards.forEach((c) => c.addEventListener("click", () => {
        if (c.onclick) {
          c.onclick();
        } else {
          navigateTo(c.dataset.target);
        }
      }));
      otherLinks.forEach((c) => c.addEventListener("click", () => {
        if (c.dataset.target) {
          navigateTo(c.dataset.target);
        }
      }));
      navBtns.forEach((c) => c.addEventListener("click", () => navigateTo(c.dataset.target)));

      backBtn.addEventListener("click", () => {
        if (pageHistory.length > 1) {
          pageHistory.pop();
          navigateTo(pageHistory[pageHistory.length - 1]);
      document.getElementById("btnAssess").addEventListener("click", () => {
        const db = loadDB();
        const vals = [...document.querySelectorAll(".assess-item")].map((x) => Number(x.value));
        if (vals.length !== QUESTIONS.length) {
          showToast("请完成所有题目");
          return;
        }
        const height = parseFloat(document.getElementById("heightInput").value) || null;
        const weight = parseFloat(document.getElementById("weightInput").value) || null;
        const bodyFeel = document.getElementById("bodyFeel").value || "";

        const score = vals.reduce((a, b) => a + b, 0); // 9~45
        const ts = Date.now();

        // 生成建议
        const advice = [];
  
        // 1. 根据总分数，提供整体调节建议
        if (score >= 30) {
          advice.push("🌿 建议维持：你已经表现出良好的调节能力。建议每日 1 次正念呼吸（约 2 分钟），并加入一次自我肯定语练习，例如："我愿意温柔地对待自己"。");
        } else {
          advice.push("🌿 建议提升：你的焦虑可能较明显。请尝试每日安排 2 次放松练习（如腹式呼吸、身体扫描），每周至少 1 次进行思维记录，观察情绪波动与身体的关系。");
        }
        
        if (score >= 45) {
          advice.push("🌟 非常良好：你展现出极强的身体觉察和调节能力。继续保持当前的节奏，也可以尝试帮助他人建立身心调节意识。");
        } else if (score >= 36) {
          advice.push("🌿 状态稳定：你具备一定的身体觉察力和自我关怀能力。建议持续每日 1 次正念呼吸，并定期复盘情绪与身体关系。");
        } else if (score >= 25) {
          advice.push("🌤 可提升空间：你已经在尝试觉察身体与情绪的关联，建议尝试将日常练习更规律地融入生活。");
        } else if (score >= 15) {
          advice.push("🌧 初现焦虑：你可能已经感受到身体上的紧绷或疲惫，与焦虑相关。建议从简单的每日任务开始，慢慢建立调节的节奏。");
        } else {
          advice.push("⛈ 警示状态：你当前的身心状态可能处于较高压阶段，建议优先考虑自我调节练习，并在需要时寻求专业支持。");
        }

        // 2. 根据身体感受（bodyFeel）给出个性化任务
        if (bodyFeel === "不自信") {
          advice.push("📝 今日小任务：写下 3 条你身体的功能性优点（例如："我的身体让我可以自由行走"、"可以消化食物"、"可以感知温度"），并对身体说一句鼓励的话。");
        }
        if (bodyFeel === "紧绷") {
          advice.push("🧘 今日小任务：进行一次 4-2-6 呼吸练习（吸气 4 秒，屏息 2 秒，呼气 6 秒，重复 10 轮），接着做肩颈伸展或全身摇摆 5 分钟。");
        }
        if (bodyFeel === "疲惫") {
          advice.push("🌙 今日小任务：今晚早点入睡前，尝试用 3 分钟进行"身体扫描冥想"（从脚到头注意各部位感受），并对自己说："今天已经尽力了"。");
        }

        // 3. 可选：推荐阅读材料（固定或随机）
        advice.push("📘 推荐阅读: <a href='https://www.medicalnewstoday.com/articles/322510' target='_blank'>《为什么我们会对身体感到焦虑》</a> — 这是一篇简短的心理学文章，帮助你理解身体焦虑的来源。");

        db.assessments.push({
          ts,
          score,
          vals,
          height,
          weight,
          bodyFeel,
          advice,
        });
        touchStreak(db);
        saveDB(db);
        unlockBadgesIfNeeded(db);
        renderHome();
        
        const adviceStr = encodeURIComponent(advice.join(",,"));
        window.location.href = `result.html?advice=${adviceStr}`;

        const box = document.getElementById("assessResult");
        const ul = document.getElementById("adviceList");
        ul.innerHTML = advice.map((t) => `<li>${t}</li>`).join("");
        box.classList.remove("hidden");
      /*****************
       * 自动思维记录
       *****************/
      const btnSaveTR = document.getElementById("btnSaveTR");
      btnSaveTR.addEventListener("click", () => {
        const contextSel = document.getElementById("trContext").value;
        const contextCustom = document.getElementById("trContextCustom").value.trim();
        const thought = document.getElementById("trThought").value.trim();
        const evidence = document.getElementById("trEvidence").value.trim();
        const emotion = Number(document.getElementById("trEmotion").value) || 5;
        const ctx = contextSel.includes("其他") ? (contextCustom || "未填写") : (contextSel || contextCustom);

        if (!thought) return showToast("请先填写当时的想法～");

        const db = loadDB();
        db.records.push({
          ts: Date.now(),
          context: ctx || "未填写",
          thought,
          evidence,
          emotion,
        });
        touchStreak(db);
        saveDB(db);
        unlockBadgesIfNeeded(db);
        renderTRPreview();
        renderHome();
        showToast("已保存到本地记录");
      });

      function renderTRPreview() {
        const db = loadDB();
        const box = document.getElementById("trPreview");
        if (!db.records.length) {
          box.textContent = "暂无记录，保存后会显示预览。";
          return;
        }
        const r = db.records[db.records.length - 1];
        box.innerHTML = `
          <div class="flex justify-between items-start mb-3">
            <span class="text-sm text-gray-500">记录时间</span>
            <span class="text-sm font-medium">${fmtTime(r.ts)}</span>
          </div>
          <div class="mb-2"><span class="text-sm text-gray-500 block mb-1">情境</span><p class="text-sm">${r.context}</p></div>
          <div class="mb-2"><span class="text-sm text-gray-500 block mb-1">当时的想法</span><p class="text-sm">${r.thought || "-"}</p></div>
          <div class="mb-2"><span class="text-sm text-gray-500 block mb-1">证据</span><p class="text-sm">${r.evidence || "-"}</p></div>
          <div><span class="text-sm text-gray-500 block mb-1">情绪强度</span>
            <div class="flex items-center">
              <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden mr-2">
                <div class="h-full bg-red-400 rounded-full" style="width:${r.emotion * 10}%"></div>
              </div>
              <span class="text-sm font-medium">${r.emotion} 分</span>
            </div>
          </div>
        `;
      }

      // 导出 CSV（思维记录）
      document.getElementById("btnExportCSV").addEventListener("click", () => {
        const { records } = loadDB();
        if (!records.length) return showToast("暂无数据可导出");
        const header = ["时间", "情境", "想法", "证据", "情绪强度"];
        const rows = records.map((r) => [fmtTime(r.ts), r.context, r.thought.replace(/\n/g, " "), (r.evidence || "").replace(/\n/g, " "), r.emotion]);
        const csv = [header, ...rows].map((r) => r.map((x) => `"${(x + "").replace(/"/g, '""')}"`).join(",")).join("\n");
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "mindfit_thought_records.csv";
        a.click();
        URL.revokeObjectURL(url);
      });

      // 打印为 PDF（浏览器端）
      document.getElementById("btnPrint").addEventListener("click", () => {
        const win = window.open("", "_blank");
        const { records } = loadDB();
        win.document.write(`<html><head><title>思维记录打印</title></head><body><h2>思维记录</h2>`);
        if (!records.length) {
          win.document.write("<p>暂无记录</p>");
        } else {
          records.forEach((r) => {
            win.document.write(`<div style="margin:12px 0;padding:12px;border:1px solid #eee">
              <div><b>时间：</b>${fmtTime(r.ts)}</div>
              <div><b>情境：</b>${r.context}</div>
              <div><b>想法：</b>${r.thought.replace(/\n/g, "<br/>")}</div>
              <div><b>证据：</b>${(r.evidence || "").replace(/\n/g, "<br/>")}</div>
              <div><b>情绪强度：</b>${r.emotion} 分</div>
            </div>`);
          });
        }
        win.document.write(`</body></html>`);
        win.document.close();
        win.focus();
      /*****************
       * 情绪练习
       *****************/
      document.querySelectorAll(".complete-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const card = btn.closest(".emotion-card");
          const cardId = card?.dataset?.card || "unknown";
          const db = loadDB();
          db.emotions.push({ card: cardId, ts: Date.now() });
          touchStreak(db);
          saveDB(db);
          unlockBadgesIfNeeded(db);
          renderEmotionStats();
          renderHome();

          // 视觉标记
          card.classList.add("opacity-60");
          const sticker = card.querySelector(".done-sticker");
          if (sticker) sticker.classList.remove("hidden");
          btn.innerHTML = "已完成";
          btn.classList.remove("border-primary", "text-primary", "hover:bg-primary", "hover:text-white");
          btn.classList.add("border-gray-300", "text-gray-500", "bg-gray-100");
          showToast("已标记完成！");
        });
      });

      function calcWeekStats(items) {
        const now = new Date();
        const startOfWeek = new Date(now);
        startOfWeek.setDate(now.getDate() - now.getDay()); // 周日为 0
        const cnt = items.filter((x) => new Date(x.ts) >= startOfWeek).length;
        return cnt;
      }

      function renderEmotionStats() {
        const db = loadDB();
        const week = calcWeekStats(db.emotions);
        const total = db.emotions.length;
        document.getElementById("statWeek").textContent = `${Math.min(7, week)}/7`;
        document.getElementById("statTotal").textContent = total;
        document.getElementById("statStreak").textContent = db.streak.count;
        document.getElementById("statBar").style.width = `${Math.min(100, (week / 7) * 100)}%`;
      }

      function renderEmotionRecs() {
        const db = loadDB();
        const list = document.getElementById("emotionRecs");
        // 简单推荐：若最近情绪强度>=7，优先推荐呼吸 & 情绪命名；否则推荐正念饮食
        const lastTR = db.records.slice(-1)[0];
        const high = lastTR && lastTR.emotion >= 7;
        const recs = high
          ? [
              { title: "立刻试试 4-2-6 呼吸", desc: "2 分钟快速稳定情绪", tag: "应急", img: 21 },
              { title: "情绪命名清单", desc: "给情绪一个名字就会变小", tag: "情绪", img: 22 },
            ]
          : [
              { title: "正念饮食入门", desc: "从一颗葡萄干开始", tag: "正念", img: 23 },
              { title: "身体中立 3 步", desc: "关注功能而非外貌", tag: "理念", img: 24 },
            ];
        list.innerHTML = recs
          .map(
            (r) => `<div class="bg-white rounded-xl overflow-hidden card-shadow flex">
              <img src="https://picsum.photos/120/120?random=${r.img}" class="w-24 h-24 object-cover flex-shrink-0" alt="${r.title}">
              <div class="p-3 flex-grow">
                <h4 class="font-medium text-sm mb-1">${r.title}</h4>
                <p class="text-xs text-gray-500 mb-2 line-clamp-2">${r.desc}</p>
                <span class="badge bg-blue-50 text-primary">${r.tag}</span>
              </div>
            </div>`
          )
          .join("");
      }

      /*****************
       * 行为实验
       *****************/
      document.getElementById("btnSaveBX").addEventListener("click", () => {
        const db = loadDB();
        const item = {
          ts: Date.now(),
          belief: document.getElementById("bxBelief").value.trim(),
          steps: [document.getElementById("bxStep1").value.trim(), document.getElementById("bxStep2").value.trim(), document.getElementById("bxStep3").value.trim()].filter(Boolean),
          predict: document.getElementById("bxPredict").value.trim(),
          actual: document.getElementById("bxActual").value.trim(),
          learn: document.getElementById("bxLearn").value.trim(),
        };
        if (!item.belief) return showToast("请先填写担忧信念");
        db.experiments.push(item);
        touchStreak(db);
        saveDB(db);
        unlockBadgesIfNeeded(db);
        renderBXList();
        showToast("实验已保存");
      });

      function renderBXList() {
        const db = loadDB();
        const box = document.getElementById("bxList");
        if (!db.experiments.length) {
          box.innerHTML = `<div class="text-sm text-gray-500">暂无记录</div>`;
          return;
        }
        box.innerHTML = db.experiments
          .slice(-3)
          .reverse()
          .map(
            (e) => `<div class="bg-white rounded-lg p-4 card-shadow">
            <div class="flex justify-between items-start mb-2">
              <h4 class="font-medium">实验：${e.belief.slice(0, 16)}${e.belief.length > 16 ? "..." : ""}</h4>
              <span class="text-xs text-gray-500">${fmtTime(e.ts)}</span>
            </div>
            <p class="text-sm text-gray-600 line-clamp-2 mb-2">${e.predict ? "预测：" + e.predict : ""}</p>
            <div class="flex justify-between items-center">
              <span class="badge bg-green-50 text-green-600">已保存</span>
            </div>
          </div>`
          )
          .join("");
      }

      // BMI计算功能
      document.getElementById('calculateBMI').addEventListener('click', () => {
        const height = parseFloat(document.getElementById('bmiHeight').value);
        const weight = parseFloat(document.getElementById('bmiWeight').value);
        const age = parseFloat(document.getElementById('bmiAge').value);
        const gender = document.querySelector('input[name="bmiGender"]:checked')?.value;

        if (!height || !weight || !age || !gender) {
          showToast('请填写完整信息');
          return;
        }

        // 计算BMI
        const bmi = weight / Math.pow(height / 100, 2);
        const bmiValue = bmi.toFixed(1);

        // 确定BMI分类
        let category, categoryClass, advice;
        
        if (bmi < 18.5) {
          category = '偏瘦';
          categoryClass = 'bg-blue-100 text-blue-800';
          advice = '体重可能偏低，建议均衡饮食，适当增加营养摄入。关注身体能量和健康状态比单纯增重更重要。';
        } else if (bmi < 24) {
          category = '正常';
          categoryClass = 'bg-green-100 text-green-800';
          advice = '恭喜！您的BMI在正常范围内。继续保持健康的生活方式，关注身体功能和整体健康状况。';
        } else if (bmi < 28) {
          category = '偏重';
          categoryClass = 'bg-yellow-100 text-yellow-800';
          advice = '建议适度调整饮食结构和增加运动。记住，健康的身体不仅仅是体重数字，更重要的是整体的活力和功能。';
        } else {
          category = '肥胖';
          categoryClass = 'bg-red-100 text-red-800';
          advice = '建议咨询专业医生或营养师，制定个性化的健康管理计划。重要的是循序渐进，关爱自己的身体。';
        }

        // 显示结果
        document.getElementById('bmiValue').textContent = bmiValue;
        document.getElementById('bmiCategory').textContent = category;
        document.getElementById('bmiCategory').className = `inline-block px-3 py-1 rounded-full text-sm font-medium ${categoryClass}`;
        document.getElementById('bmiAdvice').textContent = advice;
        document.getElementById('bmiResult').classList.remove('hidden');

        // 保存按钮功能
        document.getElementById('saveBMI').onclick = () => {
          const db = loadDB();
          const bmiData = {
            ts: Date.now(),
            height,
            weight,
            age,
            gender,
            bmi: parseFloat(bmiValue),
            category,
            advice
          };
          
          if (!db.bmiAssessments) db.bmiAssessments = [];
          db.bmiAssessments.push(bmiData);
          saveDB(db);
          showToast('BMI结果已保存');
          renderRecentAssessments();
        };
      });

      // 身材焦虑测评功能
      function initBodyAnxietyAssessment() {
        currentQuestion = 0;
        bodyAnxietyAnswers = [];
        showQuestion(0);
        updateProgress();
      }

      function showQuestion(index) {
        if (index >= BODY_ANXIETY_QUESTIONS.length) {
          completeBodyAnxietyAssessment();
          return;
        }

        document.getElementById('currentQuestionNum').textContent = index + 1;
        document.getElementById('questionText').textContent = BODY_ANXIETY_QUESTIONS[index];
        
        // 清除之前的选择
        document.querySelectorAll('input[name="currentAnswer"]').forEach(input => {
          input.checked = false;
        });

        // 如果有之前的答案，显示
        if (bodyAnxietyAnswers[index]) {
          document.querySelector(`input[name="currentAnswer"][value="${bodyAnxietyAnswers[index]}"]`).checked = true;
          document.getElementById('nextQuestion').disabled = false;
        } else {
          document.getElementById('nextQuestion').disabled = true;
        }

        // 更新按钮状态
        document.getElementById('prevQuestion').disabled = index === 0;
        document.getElementById('nextQuestion').textContent = 
          index === BODY_ANXIETY_QUESTIONS.length - 1 ? '完成测评' : '下一题';
      }

      function updateProgress() {
        const progress = Math.round((currentQuestion / BODY_ANXIETY_QUESTIONS.length) * 100);
        document.getElementById('progressBar').style.width = `${progress}%`;
        document.getElementById('progressText').textContent = `${currentQuestion}/${BODY_ANXIETY_QUESTIONS.length}`;
      }

      // 答案选择事件
      document.querySelectorAll('.answer-option').forEach(option => {
        option.addEventListener('click', () => {
          const value = option.dataset.value;
          const radio = option.querySelector('input[type="radio"]');
          radio.checked = true;
          bodyAnxietyAnswers[currentQuestion] = parseInt(value);
          document.getElementById('nextQuestion').disabled = false;
        });
      });

      // 导航按钮事件
      document.getElementById('prevQuestion').addEventListener('click', () => {
        if (currentQuestion > 0) {
          currentQuestion--;
          showQuestion(currentQuestion);
          updateProgress();
        }
      });

      document.getElementById('nextQuestion').addEventListener('click', () => {
        if (bodyAnxietyAnswers[currentQuestion]) {
          currentQuestion++;
          showQuestion(currentQuestion);
          updateProgress();
        }
      });

      function completeBodyAnxietyAssessment() {
        const totalScore = bodyAnxietyAnswers.reduce((sum, score) => sum + score, 0);
        const maxScore = BODY_ANXIETY_QUESTIONS.length * 4;
        const percentage = Math.round((totalScore / maxScore) * 100);

        // 生成建议
        const advice = generateBodyAnxietyAdvice(totalScore, percentage);

        // 保存结果
        const db = loadDB();
        if (!db.bodyAnxietyAssessments) db.bodyAnxietyAssessments = [];
        
        const assessmentData = {
          ts: Date.now(),
          answers: bodyAnxietyAnswers,
          totalScore,
          percentage,
          advice
        };
        
        db.bodyAnxietyAssessments.push(assessmentData);
        touchStreak(db);
        saveDB(db);
        renderRecentAssessments();

        // 跳转到结果页面
        const adviceStr = encodeURIComponent(advice.join(",,"));
        window.location.href = `result.html?advice=${adviceStr}`;
      }

      function generateBodyAnxietyAdvice(score, percentage) {
        const advice = [];
        
        if (percentage >= 75) {
          advice.push("⛈ 高度焦虑：你当前的身材焦虑程度较高，建议优先考虑专业心理支持，配合自我调节练习。");
      function generateBodyAnxietyAdvice(score, percentage) {
        const advice = [];
        
        if (percentage >= 75) {
          advice.push("⛈ 高度焦虑：你当前的身材焦虑程度较高，建议优先考虑专业心理支持，配合自我调节练习。");
          advice.push("🧘 今日小任务：进行一次 10 分钟的身体扫描冥想，关注身体的功能而非外貌。");
        } else if (percentage >= 50) {
          advice.push("🌧 中度焦虑：你对身材有一定程度的焦虑，建议尝试身体中立练习和正念技巧。");
          advice.push("📝 今日小任务：写下 3 条你身体的功能性优点，例如"我的身体让我可以自由行走"。");
        } else if (percentage >= 25) {
          advice.push("🌤 轻度焦虑：你偶尔会对身材感到担忧，这很正常。建议保持积极的身体意识。");
          advice.push("🌿 今日小任务：每日 1 次正念呼吸（约 3 分钟），并练习自我肯定语。");
        } else {
          advice.push("🌟 状态良好：你对身材保持着健康的态度，继续保持这种平衡的心态。");
          advice.push("💫 今日小任务：分享你的积极心态，帮助身边的人建立健康的身体观念。");
        }

        advice.push("📘 推荐阅读: <a href='body-neutrality.html' target='_blank'>身体中立入门指南</a> — 学习如何建立更健康的身体关系。");
        
        return advice;
      }

      function renderRecentAssessments() {
        const db = loadDB();
        const container = document.getElementById('recentAssessments');
        
        const bmiTests = (db.bmiAssessments || []).map(test => ({
          type: 'BMI测评',
          ts: test.ts,
          result: `BMI: ${test.bmi} (${test.category})`
        }));
        
        const anxietyTests = (db.bodyAnxietyAssessments || []).map(test => ({
          type: '身材焦虑自评',
          ts: test.ts,
          result: `得分: ${test.totalScore}/36 (${test.percentage}%)`
        }));
        
        const allTests = [...bmiTests, ...anxietyTests]
          .sort((a, b) => b.ts - a.ts)
          .slice(0, 3);

        if (allTests.length === 0) {
          container.innerHTML = '<div class="text-sm text-gray-500">暂无测评记录</div>';
          return;
        }

        container.innerHTML = allTests.map(test => `
          <div class="flex items-center justify-between py-2 border-b border-gray-200 last:border-b-0">
            <div>
              <div class="text-sm font-medium text-gray-800">${test.type}</div>
              <div class="text-xs text-gray-500">${fmtTime(test.ts)}</div>
            </div>
            <div class="text-xs text-gray-600">${test.result}</div>
          </div>
        `).join('');
      }

      /*****************
       * 轻测评（9题）
       *****************/
      const QUESTIONS = [
        "照镜子或翻看照片时，我会特别关注自己的某些身体部位",
        "我会把自己和社交媒体上的"完美身材"比较",
        "吃完喜欢的食物后，我会感到后悔或愧疚",
        "如果对自己的外貌不满意，我会情绪低落或心情受到影响",
        "我会给自己制定严格的饮食或运动计划，若未完成会自责",
        "因为担心身材，我会避免拍照或参加社交活动",
        "我觉得类似于"如果我变得更好看，生活会更顺利"这类想法有一定道理",
        "我想摆脱这些焦虑想法，但不知道从哪里开始",
        "如果有简单可操作的心理自助练习（例如思维记录、情绪卡片等），我愿意尝试",
      ];

      function renderAssessment() {
        // BMI 文本
        const h = document.getElementById("heightInput");
        const w = document.getElementById("weightInput");
        const bmiText = document.getElementById("bmiText");
        const updateBMI = () => {
          const hv = parseFloat(h.value) || 0;
          const wv = parseFloat(w.value) || 0;
          if (!hv || !wv) {
            bmiText.textContent = "";
            return;
          }
          const bmi = (wv / Math.pow(hv / 100, 2)).toFixed(1);
          let label = "功能健康角度：关注身体能做什么，而非数字。";
          if (bmi < 18.5) label = "提示：可能偏瘦，注意营养与能量补充。";
          else if (bmi < 24) label = "提示：总体良好，继续保持均衡与觉察。";
          else if (bmi < 28) label = "提示：适度调整饮食与活动，循序渐进。";
          else label = "提示：建议在专业指导下稳步管理与监测。";
          bmiText.textContent = `BMI≈${bmi}。${label}`;
        };
        h.oninput = updateBMI;
        w.oninput = updateBMI;

        // 渲染 9 题
        const qList = document.getElementById("qList");
        if (!qList.dataset.rendered) {
          qList.innerHTML = QUESTIONS.map((q, i) => {
            return `<div>
                <label class="block text-sm text-gray-700 mb-1">${i + 1}. ${q}</label>
                <input type="range" min="1" max="5" value="3" class="w-full h-2 bg-gray-200 rounded-lg accent-primary assess-item" data-idx="${i}">
                <div class="flex justify-between text-xs text-gray-400"><span>1 从不</span><span>5 总是</span></div>
              </div>`;
          }).join("");
          qList.dataset.rendered = "1";
        }
      }

      // 首次进入，渲染首页
      renderHome();
      renderTRPreview();

      // 添加了解自己页面内的导航事件
      document.addEventListener('click', (e) => {
        if (e.target.closest('[data-target="bmiAssessmentPage"]')) {
          navigateTo('bmiAssessmentPage');
        } else if (e.target.closest('[data-target="bodyAnxietyAssessmentPage"]')) {
          navigateTo('bodyAnxietyAssessmentPage');
        }
      });    <!-- 了解自己页面 -->
    <section id="selfAssessmentPage" class="page hidden">
      <div class="px-4 py-6">
        <div class="mb-6">
          <h2 class="text-xl font-bold mb-2">了解自己</h2>
          <p class="text-gray-500 text-sm">通过科学测评，更好地认知当下的自己</p>
        </div>

        <!-- 测评卡片网格 -->
        <div class="space-y-4">
          <!-- BMI测评卡片 -->
          <div class="bg-white rounded-xl p-6 card-shadow cursor-pointer hover:shadow-lg transition-all" data-target="bmiAssessmentPage">
            <div class="flex items-center">
              <div class="w-14 h-14 rounded-full bg-blue-100 flex items-center justify-center mr-4">
                <i class="ph ph-scales text-blue-500 text-2xl"></i>
              </div>
              <div class="flex-1">
                <h3 class="text-lg font-semibold text-gray-800 mb-1">BMI 身体测评</h3>
                <p class="text-sm text-gray-500 mb-2">了解身体状况，建立健康认知</p>
                <div class="flex items-center text-xs text-gray-400">
                  <i class="fa fa-clock-o mr-1"></i>
                  <span>约2分钟</span>
                </div>
              </div>
              <i class="fa fa-chevron-right text-gray-300 text-lg"></i>
            </div>
          </div>

          <!-- 身材焦虑自评卡片 -->
          <div class="bg-white rounded-xl p-6 card-shadow cursor-pointer hover:shadow-lg transition-all" data-target="bodyAnxietyAssessmentPage">
            <div class="flex items-center">
              <div class="w-14 h-14 rounded-full bg-pink-100 flex items-center justify-center mr-4">
                <i class="ph ph-heart text-pink-500 text-2xl"></i>
              </div>
              <div class="flex-1">
                <h3 class="text-lg font-semibold text-gray-800 mb-1">身材焦虑自评</h3>
                <p class="text-sm text-gray-500 mb-2">9题量表，评估身材焦虑程度</p>
                <div class="flex items-center text-xs text-gray-400">
                  <i class="fa fa-clock-o mr-1"></i>
                  <span>约3分钟</span>
                </div>
              </div>
              <i class="fa fa-chevron-right text-gray-300 text-lg"></i>
            </div>
          </div>

          <!-- 历史记录 -->
          <div class="bg-gray-50 rounded-xl p-4">
            <h4 class="text-sm font-medium text-gray-700 mb-3">最近测评</h4>
            <div id="recentAssessments" class="space-y-2">
              <div class="text-sm text-gray-500">暂无测评记录</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- BMI测评页面 -->
    <section id="bmiAssessmentPage" class="page hidden">
      <div class="px-4 py-6">
        <div class="mb-6">
          <h2 class="text-xl font-bold mb-2">BMI 身体测评</h2>
          <p class="text-gray-500 text-sm">了解基础身体指标，建立健康的身体认知</p>
        </div>

        <!-- 输入区域 -->
        <div class="bg-white rounded-xl p-6 card-shadow mb-6">
          <h3 class="text-lg font-semibold mb-4">基础信息</h3>
          
          <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">身高 (cm)</label>
                <input id="bmiHeight" type="number" min="80" max="230" 
                       class="w-full p-3 border border-gray-200 rounded-lg focus:border-primary focus:ring-1 focus:ring-primary outline-none" 
                       placeholder="165" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">体重 (kg)</label>
                <input id="bmiWeight" type="number" min="20" max="250" step="0.1"
                       class="w-full p-3 border border-gray-200 rounded-lg focus:border-primary focus:ring-1 focus:ring-primary outline-none" 
                       placeholder="55.5" />
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">年龄</label>
              <input id="bmiAge" type="number" min="10" max="100" 
                     class="w-full p-3 border border-gray-200 rounded-lg focus:border-primary focus:ring-1 focus:ring-primary outline-none" 
                     placeholder="25" />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">性别</label>
              <div class="flex space-x-4">
                <label class="flex items-center">
                  <input type="radio" name="bmiGender" value="female" class="mr-2 text-primary">
                  <span>女性</span>
                </label>
                <label class="flex items-center">
                  <input type="radio" name="bmiGender" value="male" class="mr-2 text-primary">
                  <span>男性</span>
                </label>
              </div>
            </div>
          </div>

          <button id="calculateBMI" class="w-full mt-6 py-3 bg-primary text-white rounded-lg font-medium hover:bg-primary/90 transition-colors">
            <i class="fa fa-calculator mr-2"></i>计算 BMI
          </button>
        </div>

        <!-- 结果显示区域 -->
        <div id="bmiResult" class="hidden bg-white rounded-xl p-6 card-shadow mb-6">
          <h3 class="text-lg font-semibold mb-4">测评结果</h3>
          
          <div class="text-center mb-6">
            <div class="text-3xl font-bold text-primary mb-2" id="bmiValue">--</div>
            <div class="text-sm text-gray-500 mb-4">您的BMI指数</div>
            <div class="inline-block px-3 py-1 rounded-full text-sm font-medium" id="bmiCategory">
              <!-- 动态显示分类 -->
            </div>
          </div>

          <div class="space-y-4">
            <div class="bg-blue-50 rounded-lg p-4">
              <h4 class="font-medium text-blue-800 mb-2">健康建议</h4>
              <p id="bmiAdvice" class="text-sm text-blue-700">
                <!-- 动态显示建议 -->
              </p>
            </div>

            <div class="bg-yellow-50 rounded-lg p-4">
              <h4 class="font-medium text-yellow-800 mb-2">身体中立提醒</h4>
              <p class="text-sm text-yellow-700">
                BMI只是一个参考指标，不能完全反映健康状况。重要的是关注身体的功能和感受，而不仅仅是数字。
              </p>
            </div>
          </div>

          <button id="saveBMI" class="w-full mt-4 py-3 bg-secondary text-white rounded-lg font-medium hover:bg-secondary/90 transition-colors">
            <i class="fa fa-save mr-2"></i>保存结果
          </button>
        </div>
      </div>
    </section>

    <!-- 身材焦虑自评页面 -->
    <section id="bodyAnxietyAssessmentPage" class="page hidden">
      <div class="px-4 py-6">
        <div class="mb-6">
          <h2 class="text-xl font-bold mb-2">身材焦虑自评</h2>
          <p class="text-gray-500 text-sm">通过9道题目，了解你对身体形象的感受</p>
        </div>

        <!-- 进度指示器 -->
        <div class="bg-white rounded-xl p-4 card-shadow mb-6">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium text-gray-700">答题进度</span>
            <span id="progressText" class="text-sm text-primary">0/9</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div id="progressBar" class="bg-primary h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
          </div>
        </div>

        <!-- 题目卡片 -->
        <div id="questionCard" class="bg-white rounded-xl p-6 card-shadow mb-6">
          <div class="mb-4">
            <span class="text-sm text-gray-500">第 <span id="currentQuestionNum">1</span> 题</span>
          </div>
          
          <h3 id="questionText" class="text-lg font-medium text-gray-800 mb-6 leading-relaxed">
            <!-- 动态显示题目 -->
          </h3>

          <div class="space-y-3">
            <div class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:border-primary hover:bg-blue-50 transition-all answer-option" data-value="1">
              <input type="radio" name="currentAnswer" value="1" class="mr-3 text-primary">
              <span>完全不同意</span>
            </div>
            <div class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:border-primary hover:bg-blue-50 transition-all answer-option" data-value="2">
              <input type="radio" name="currentAnswer" value="2" class="mr-3 text-primary">
              <span>不太同意</span>
            </div>
            <div class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:border-primary hover:bg-blue-50 transition-all answer-option" data-value="3">
              <input type="radio" name="currentAnswer" value="3" class="mr-3 text-primary">
              <span>有些同意</span>
            </div>
            <div class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:border-primary hover:bg-blue-50 transition-all answer-option" data-value="4">
              <input type="radio" name="currentAnswer" value="4" class="mr-3 text-primary">
              <span>非常同意</span>
            </div>
          </div>
        </div>

        <!-- 导航按钮 -->
        <div class="flex space-x-3">
          <button id="prevQuestion" class="flex-1 py-3 border border-gray-300 text-gray-600 rounded-lg font-medium hover:bg-gray-50 transition-colors" disabled>
            <i class="fa fa-chevron-left mr-2"></i>上一题
          </button>
          <button id="nextQuestion" class="flex-1 py-3 bg-primary text-white rounded-lg font-medium hover:bg-primary/90 transition-colors" disabled>
            下一题<i class="fa fa-chevron-right ml-2"></i>
          </button>
        </div>
      </div>
    </section>

    <!-- 身心轻测评 -->
    <section id="assessmentPage" class="page hidden">


